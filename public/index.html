<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>‡∞∞‡±à‡∞§‡±Å ‡∞™‡∞æ‡∞≤‡±Å</title>
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    :root {
      --primary: #43a047; 
      --primary-dark: #2e7d32;
      --sidebar-bg: #43a047; 
      --bg: #f8f9fa;
      --text: #333;
      --card-bg: #fff;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .dark-mode {
      --primary: #66bb6a;
      --primary-dark: #2e7d32;
      --sidebar-bg: #1b5e20;
      --bg: #121212;
      --text: #e0e0e0;
      --card-bg: #1e1e1e;
      --shadow: 0 4px 15px rgba(0,0,0,0.5);
    }

    * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; transition: background 0.3s, color 0.3s; -webkit-tap-highlight-color: transparent; }
    
    body { margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

    /* --- SIDEBAR --- */
    .dashboard-container { display: flex; width: 100%; height: 100%; }
    .sidebar { width: 280px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; padding: 20px; box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 10; }
    
    .logo { font-size: 24px; font-weight: bold; margin-bottom: 20px; text-align: center; letter-spacing: 0.5px; }
    .logo span { background: #fff; color: var(--sidebar-bg); padding: 2px 8px; border-radius: 4px; }
    .greeting { font-size: 16px; font-weight: 500; margin-bottom: 30px; opacity: 0.95; padding-left: 10px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px; }
    
    .sidebar-btn {
      background: rgba(255,255,255,0.1); color: white; padding: 12px 20px;
      margin-bottom: 12px; border-radius: 8px; cursor: pointer; display: flex;
      align-items: center; gap: 12px; font-weight: 500; transition: all 0.2s;
    }
    .sidebar-btn:hover { background: rgba(255,255,255,0.25); transform: translateX(5px); }
    .sidebar-btn.active { background: #fff; color: var(--sidebar-bg); font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    
    /* --- MAIN AREA --- */
    .main-content { flex: 1; padding: 40px; overflow-y: auto; position: relative; }
    
    /* Top Controls (Theme/Lang) */
    .top-controls { position: absolute; top: 20px; right: 30px; display: flex; gap: 15px; align-items: center; z-index: 100; }
    select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; background: var(--card-bg); color: var(--text); cursor: pointer; }
    .theme-btn { font-size: 24px; cursor: pointer; background: none; border: none; padding: 0; }

    /* --- CARDS & LAYOUTS --- */
    h2 { color: var(--primary); margin-top: 0; margin-bottom: 20px; border-bottom: 2px solid var(--primary); display: inline-block; padding-bottom: 5px; font-size: 1.5rem; }
    
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px; }
    
    .card {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      height: 100%;
      overflow: hidden; /* Contain children */
    }

    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 30px; }
    
    .stat-box {
      padding: 15px; border-radius: 12px; color: white; text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: transform 0.2s;
    }
    .stat-box h3 { margin: 0 0 5px 0; opacity: 0.9; font-size: 0.9rem; }
    .stat-box h1 { margin: 0; font-size: 1.8rem; }

    /* Tables - Critical for Mobile */
    .table-container { width: 100%; overflow-x: auto; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; min-width: 400px; } /* Min width ensures scroll on mobile */
    th { background: var(--primary); color: white; padding: 12px; text-align: center; font-size: 14px; white-space: nowrap; }
    td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; background: var(--card-bg); font-size: 14px; white-space: nowrap; }
    
    /* Breakdown List */
    .breakdown-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 10px 0; font-size: 14px; }
    .breakdown-item:last-child { border: none; font-weight: bold; color: var(--primary); font-size: 16px; margin-top: 5px; }

    /* Buttons */
    button { padding: 12px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; }
    button:active { transform: scale(0.98); }
    .btn-red { background: #e53935; padding: 6px 12px; font-size: 12px; }
    .btn-blue { background: #1e88e5; }
    
    .milk-btn { display: inline-block; width: 45%; margin: 2%; background: transparent; color: var(--text); border: 2px solid var(--primary); padding: 10px; }
    .milk-btn.active { background: var(--primary); color: white; }

    /* Inputs */
    input, select, textarea { width: 100%; padding: 12px; margin: 8px 0 20px 0; border: 1px solid #ddd; border-radius: 6px; background: #fafafa; font-size: 16px; } /* 16px prevents iOS zoom */
    .pass-wrapper { position: relative; width: 100%; }
    .pass-icon { position: absolute; right: 12px; top: 40%; transform: translateY(-50%); cursor: pointer; font-size: 18px; color: #666; }

    /* Users Grid */
    .users-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; }
    .user-box { background: #424242; color: white; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; }

    /* Month Card */
    .month-card {
      background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white;
      padding: 15px; border-radius: 12px; text-align: center; cursor: pointer;
      font-weight: bold; margin-bottom: 10px;
    }

    /* Auth */
    .auth-container { width: 100%; display: flex; justify-content: center; align-items: center; background: #e8f5e9; height: 100vh; padding: 20px; }
    .auth-box { background: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.1); }

    /* --- MOBILE RESPONSIVE CSS --- */
    @media(max-width: 768px) { 
        body { overflow-y: auto; position: relative; } /* Enable scroll on body */
        .dashboard-container { flex-direction: column; height: auto; min-height: 100vh; } 
        
        /* Mobile Header / Sidebar */
        .sidebar { 
            width: 100%; 
            height: auto; 
            flex-direction: row; 
            flex-wrap: nowrap;
            overflow-x: auto; 
            padding: 10px;
            gap: 10px;
            position: sticky; top: 0; /* Sticks to top */
            align-items: center;
        }
        
        .logo { font-size: 18px; margin: 0; margin-right: 15px; white-space: nowrap; }
        .greeting { display: none; } /* Hide greeting on mobile to save space */
        
        .sidebar-btn {
            padding: 8px 12px;
            font-size: 12px;
            margin: 0;
            white-space: nowrap;
            flex-shrink: 0;
        }

        /* Main Content Fixes */
        .main-content { padding: 15px; padding-top: 20px; overflow: visible; }
        .top-controls { 
            position: relative; 
            top: 0; right: 0; 
            justify-content: flex-end; 
            margin-bottom: 15px; 
            width: 100%; 
        }

        /* Cards & Grid */
        .grid-2 { grid-template-columns: 1fr; gap: 15px; }
        .card { padding: 20px; }
        h2 { font-size: 1.3rem; }

        /* Auth Mobile */
        .auth-box { padding: 20px; }
    }
  </style>
</head>
<body>

<div id="app" style="width:100%; height:100%"></div>
<div id="toast" style="visibility:hidden; min-width:250px; background:#333; color:#fff; text-align:center; border-radius:50px; padding:16px; position:fixed; z-index:9999; left:50%; bottom:30px; transform:translateX(-50%); box-shadow: 0 4px 10px rgba(0,0,0,0.3);"></div>

<script>
// --- CONFIG & STATE ---
const PRICES = { twoL: 140, oneL: 70, threeQuarterL: 55, halfL: 35 };
let currentLang = localStorage.getItem('lang') || 'en';
let currentTheme = localStorage.getItem('theme') || 'light';
let selectedMilk = { twoL: 0, oneL: 0, threeQuarterL: 0, halfL: 0 };
let currentMonthView = null; 

if(currentTheme === 'dark') document.body.classList.add('dark-mode');

// --- TRANSLATIONS ---
const T = {
  en: {
    welcome: "Welcome to ‡∞∞‡±à‡∞§‡±Å ‡∞™‡∞æ‡∞≤‡±Å",
    login: "Login", register: "Register", username: "Username", password: "Password",
    home: "üè† Home", profile: "üë§ Profile", progress: "üìä Progress", orders: "üì¶ Orders", feedback: "üí¨ Feedback", logout: "üö™ Logout",
    summary: "üìä Summary", users: "üë• Users", hello: "Hello",
    placeOrderTitle: "Place New Order", yourOrders: "Your Orders", history: "Order History",
    placeBtn: "Place Order", 
    feedbackTitle: "Feedback", feedbackPlace: "Share your feedback...", submitBtn: "Submit Feedback",
    back: "‚¨Ö Back", downloadPdf: "üìÑ PDF",
    q1: "1 Litre", q2: "2 Litre", q34: "3/4 Litre", q12: "1/2 Litre",
    overview: "Overview", totalDays: "Total Days", grandTotal: "Grand Total",
    cost: "Cost", date: "Date", action: "Action", save: "Save Entry", delete: "Delete",
    changePassBtn: "Change Password", oldPass: "Old Password", newPass: "New Password",
    totalRev: "Revenue", newOrders: "New Orders", pastOrders: "Past Orders", accept: "Accept", statusSuccess: "Success", statusPending: "Pending"
  },
  te: {
    welcome: "‡∞∞‡±à‡∞§‡±Å ‡∞™‡∞æ‡∞≤‡±Å‡∞ï‡±Å ‡∞∏‡±ç‡∞µ‡∞æ‡∞ó‡∞§‡∞Ç",
    login: "‡∞≤‡∞æ‡∞ó‡∞ø‡∞®‡±ç", register: "‡∞®‡∞Æ‡±ã‡∞¶‡±Å", username: "‡∞™‡±á‡∞∞‡±Å", password: "‡∞™‡∞æ‡∞∏‡±ç‚Äå‡∞µ‡∞∞‡±ç‡∞°‡±ç",
    home: "üè† ‡∞π‡±ã‡∞Æ‡±ç", profile: "üë§ ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç", progress: "üìä ‡∞™‡±Å‡∞∞‡±ã‡∞ó‡∞§‡∞ø", orders: "üì¶ ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç‡∞≤‡±Å", feedback: "üí¨ ‡∞Ö‡∞≠‡∞ø‡∞™‡±ç‡∞∞‡∞æ‡∞Ø‡∞Ç", logout: "üö™ ‡∞µ‡±Ü‡∞≥‡±ç‡∞≤‡±Å",
    summary: "üìä ‡∞∏‡∞æ‡∞∞‡∞æ‡∞Ç‡∞∂‡∞Ç", users: "üë• ‡∞µ‡∞ø‡∞®‡∞ø‡∞Ø‡±ã‡∞ó‡∞¶‡∞æ‡∞∞‡±Å‡∞≤‡±Å", hello: "‡∞π‡∞≤‡±ã",
    placeOrderTitle: "‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø", yourOrders: "‡∞Æ‡±Ä ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç‡∞≤‡±Å", history: "‡∞ö‡∞∞‡∞ø‡∞§‡±ç‡∞∞",
    placeBtn: "‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø",
    feedbackTitle: "‡∞Ö‡∞≠‡∞ø‡∞™‡±ç‡∞∞‡∞æ‡∞Ø‡∞Ç", feedbackPlace: "‡∞Æ‡±Ä ‡∞Ö‡∞≠‡∞ø‡∞™‡±ç‡∞∞‡∞æ‡∞Ø‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞µ‡±ç‡∞∞‡∞æ‡∞Ø‡∞Ç‡∞°‡∞ø...", submitBtn: "‡∞∏‡∞Æ‡∞∞‡±ç‡∞™‡∞ø‡∞Ç‡∞ö‡±Å",
    back: "‚¨Ö ‡∞µ‡±Ü‡∞®‡±Å‡∞ï‡∞ï‡±Å", downloadPdf: "üìÑ PDF",
    q1: "1 ‡∞≤‡±Ä‡∞ü‡∞∞‡±Å", q2: "2 ‡∞≤‡±Ä‡∞ü‡∞∞‡±ç‡∞≤‡±Å", q34: "3/4 ‡∞≤‡±Ä‡∞ü‡∞∞‡±Å", q12: "1/2 ‡∞≤‡±Ä‡∞ü‡∞∞‡±Å",
    overview: "‡∞Ö‡∞µ‡∞≤‡±ã‡∞ï‡∞®‡∞Ç", totalDays: "‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞∞‡±ã‡∞ú‡±Å‡∞≤‡±Å", grandTotal: "‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç",
    cost: "‡∞ß‡∞∞", date: "‡∞§‡±á‡∞¶‡±Ä", action: "‡∞ö‡∞∞‡±ç‡∞Ø", save: "‡∞≠‡∞¶‡±ç‡∞∞‡∞™‡∞∞‡∞ö‡±Å", delete: "‡∞§‡±ä‡∞≤‡∞ó‡∞ø‡∞Ç‡∞ö‡±Å",
    changePassBtn: "‡∞™‡∞æ‡∞∏‡±ç‚Äå‡∞µ‡∞∞‡±ç‡∞°‡±ç ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ö‡∞Ç‡∞°‡∞ø", oldPass: "‡∞™‡∞æ‡∞§ ‡∞™‡∞æ‡∞∏‡±ç‚Äå‡∞µ‡∞∞‡±ç‡∞°‡±ç", newPass: "‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞™‡∞æ‡∞∏‡±ç‚Äå‡∞µ‡∞∞‡±ç‡∞°‡±ç",
    totalRev: "‡∞Ü‡∞¶‡∞æ‡∞Ø‡∞Ç", newOrders: "‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç‡∞≤‡±Å", pastOrders: "‡∞™‡∞æ‡∞§ ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç‡∞≤‡±Å", accept: "‡∞Ü‡∞Æ‡±ã‡∞¶‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø", statusSuccess: "‡∞µ‡∞ø‡∞ú‡∞Ø‡∞µ‡∞Ç‡∞§‡∞Ç", statusPending: "‡∞™‡±Ü‡∞Ç‡∞°‡∞ø‡∞Ç‡∞ó‡±ç"
  },
  hi: {
    welcome: "‡∞∞‡±à‡∞§‡±Å ‡∞™‡∞æ‡∞≤‡±Å ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à",
    login: "‡§≤‡•â‡§ó ‡§á‡§®", register: "‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£", username: "‡§®‡§æ‡§Æ", password: "‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°",
    home: "üè† ‡§π‡•ã‡§Æ", profile: "üë§ ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤", progress: "üìä ‡§™‡•ç‡§∞‡§ó‡§§‡§ø", orders: "üì¶ ‡§Ü‡§∞‡•ç‡§°‡§∞", feedback: "üí¨ ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ", logout: "üö™ ‡§¨‡§æ‡§π‡§∞",
    summary: "üìä ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂", users: "üë• ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ", hello: "‡§®‡§Æ‡§∏‡•ç‡§§‡•á",
    placeOrderTitle: "‡§®‡§Ø‡§æ ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§¶‡•á‡§Ç", yourOrders: "‡§Ü‡§™‡§ï‡•á ‡§ë‡§∞‡•ç‡§°‡§∞", history: "‡§á‡§§‡§ø‡§π‡§æ‡§∏",
    placeBtn: "‡§ë‡§∞‡•ç‡§°‡§∞ ‡§¶‡•á‡§Ç",
    feedbackTitle: "‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ", feedbackPlace: "‡§Ö‡§™‡§®‡•Ä ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§≤‡§ø‡§ñ‡•á‡§Ç...", submitBtn: "‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç",
    back: "‚¨Ö ‡§™‡•Ä‡§õ‡•á", downloadPdf: "üìÑ ‡§™‡•Ä‡§°‡•Ä‡§è‡§´",
    q1: "1 ‡§≤‡•Ä‡§ü‡§∞", q2: "2 ‡§≤‡•Ä‡§ü‡§∞", q34: "3/4 ‡§≤‡•Ä‡§ü‡§∞", q12: "1/2 ‡§≤‡•Ä‡§ü‡§∞",
    overview: "‡§Ö‡§µ‡§≤‡•ã‡§ï‡§®", totalDays: "‡§ï‡•Å‡§≤ ‡§¶‡§ø‡§®", grandTotal: "‡§ï‡•Å‡§≤ ‡§Ø‡•ã‡§ó",
    cost: "‡§≤‡§æ‡§ó‡§§", date: "‡§§‡§æ‡§∞‡•Ä‡§ñ", action: "‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à", save: "‡§∏‡§π‡•á‡§ú‡•á‡§Ç", delete: "‡§π‡§ü‡§æ‡§è‡§Ç",
    changePassBtn: "‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¨‡§¶‡§≤‡•á‡§Ç", oldPass: "‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°", newPass: "‡§®‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°",
    totalRev: "‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§ú‡§∏‡•ç‡§µ", newOrders: "‡§®‡§è ‡§ë‡§∞‡•ç‡§°‡§∞", pastOrders: "‡§™‡§ø‡§õ‡§≤‡•á ‡§ë‡§∞‡•ç‡§°‡§∞", accept: "‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç", statusSuccess: "‡§∏‡§´‡§≤", statusPending: "‡§≤‡§Ç‡§¨‡§ø‡§§"
  }
};
const t = (key) => T[currentLang][key] || key;
const app = document.getElementById("app");

// --- UTILS ---
function setLang(lang) { currentLang = lang; localStorage.setItem('lang', lang); location.reload(); }
function toggleTheme() {
  currentTheme = currentTheme === 'light' ? 'dark' : 'light';
  localStorage.setItem('theme', currentTheme); document.body.classList.toggle('dark-mode');
  const btn = document.getElementById('themeIcon'); if(btn) btn.innerText = currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
}
function showToast(msg) {
  const x = document.getElementById("toast"); x.style.visibility = "visible"; x.innerText = msg;
  setTimeout(() => x.style.visibility = "hidden", 3000);
}
function getMonthName(m) { return ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][parseInt(m)-1]; }
function sortSalesByDate(sales) {
  return sales.sort((a, b) => {
    const [d1, m1, y1] = a.date.split('/'); const [d2, m2, y2] = b.date.split('/');
    return new Date(y1, m1-1, d1) - new Date(y2, m2-1, d2);
  });
}
function calculateStats(sales) {
  let stats = { t2:0, t1:0, t34:0, t12:0, days: sales.length, cost2:0, cost1:0, cost34:0, cost12:0, totalCost:0 };
  sales.forEach(s => {
    stats.t2 += s.twoL||0; stats.cost2 += (s.twoL||0)*PRICES.twoL;
    stats.t1 += s.oneL||0; stats.cost1 += (s.oneL||0)*PRICES.oneL;
    stats.t34 += s.threeQuarterL||0; stats.cost34 += (s.threeQuarterL||0)*PRICES.threeQuarterL;
    stats.t12 += s.halfL||0; stats.cost12 += (s.halfL||0)*PRICES.halfL;
  });
  stats.totalCost = stats.cost2 + stats.cost1 + stats.cost34 + stats.cost12;
  return stats;
}

// --- RENDERERS ---
function renderControls() {
  return `<div class="top-controls"><select onchange="setLang(this.value)">
    <option value="en" ${currentLang==='en'?'selected':''}>English</option>
    <option value="te" ${currentLang==='te'?'selected':''}>‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
    <option value="hi" ${currentLang==='hi'?'selected':''}>‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
  </select><button class="theme-btn" onclick="toggleTheme()" id="themeIcon">${currentTheme==='light'?'üåô':'‚òÄÔ∏è'}</button></div>`;
}

function renderDashboardShell(user, contentHTML, activeTab) {
  const role = user.role;
  const greeting = `${t('hello')} ${user.username} üëã`;
  
  const menu = role === 'admin' 
    ? [{key:'summary', label:t('summary'), func:'adminSummary()'}, {key:'orders', label:t('orders'), func:'adminOrders()'}, {key:'users', label:t('users'), func:'adminUsers()'}]
    : [{key:'home', label:t('home'), func:'userHome()'}, {key:'profile', label:t('profile'), func:'userProfile()'}, {key:'progress', label:t('progress'), func:'userProgress()'}, {key:'orders', label:t('orders'), func:'userOrders()'}, {key:'feedback', label:t('feedback'), func:'userFeedback()'}];

  const sidebarHTML = menu.map(item => `
    <div class="sidebar-btn ${activeTab===item.key?'active':''}" onclick="${item.func}">
      ${item.label}
    </div>
  `).join('');

  app.innerHTML = `
    <div class="dashboard-container">
      <div class="sidebar">
        <div class="logo">üåæ ‡∞∞‡±à‡∞§‡±Å <span>‡∞™‡∞æ‡∞≤‡±Å</span></div>
        <div class="greeting">${greeting}</div>
        ${sidebarHTML}
        <div class="sidebar-btn" style="margin-top:auto; background:#d32f2f; justify-content:center" onclick="logout()">
          ${t('logout')}
        </div>
      </div>
      <div class="main-content">
        ${renderControls()}
        ${contentHTML}
      </div>
    </div>`;
}

// --- ADMIN FUNCTIONALITY ---
async function adminSummary() {
  const u = JSON.parse(localStorage.getItem('user'));
  const res = await fetch('/users'); 
  const users = await res.json();
  
  let totalRev=0, t2=0, t1=0, t34=0, t12=0;
  users.forEach(u => u.sales.forEach(s => {
    t2 += s.twoL||0; t1 += s.oneL||0; t34 += s.threeQuarterL||0; t12 += s.halfL||0;
    totalRev += (s.twoL*PRICES.twoL)+(s.oneL*PRICES.oneL)+(s.threeQuarterL*PRICES.threeQuarterL)+(s.halfL*PRICES.halfL);
  }));

  const html = `
    <h2>${t('summary')}</h2>
    <div class="stats-grid">
      <div class="stat-box" style="background:#2e7d32"><h3>${t('totalRev')}</h3><h1>‚Çπ${totalRev.toLocaleString()}</h1></div>
      <div class="stat-box" style="background:#1565C0"><h3>${t('q2')}</h3><h1>${t2}</h1></div>
      <div class="stat-box" style="background:#E65100"><h3>${t('q1')}</h3><h1>${t1}</h1></div>
      <div class="stat-box" style="background:#6A1B9A"><h3>${t('q34')}</h3><h1>${t34}</h1></div>
      <div class="stat-box" style="background:#455A64"><h3>${t('q12')}</h3><h1>${t12}</h1></div>
    </div>
  `;
  renderDashboardShell(u, html, 'summary');
}

async function adminOrders() {
  const u = JSON.parse(localStorage.getItem('user'));
  const res = await fetch('/orders'); 
  const orders = await res.json();
  const pending = orders.filter(o => o.status === 'Pending');
  const past = orders.filter(o => o.status !== 'Pending');

  const html = `
    <h2>${t('orders')}</h2>
    
    <div class="grid-2">
      <div class="card">
        <h3 style="color:#e53935">${t('newOrders')}</h3>
        ${pending.length === 0 ? '<p>No pending orders</p>' : ''}
        ${pending.map(o => `
          <div style="display:flex; justify-content:space-between; align-items:center; padding:15px; border-bottom:1px solid #eee;">
            <div><b>${o.username}</b> - ${o.quantity}L <br> <small>${new Date(o.timestamp).toLocaleDateString()}</small></div>
            <button class="btn-green" style="background:#4CAF50; padding:5px 10px" onclick="acceptOrder('${o.id}')">${t('accept')}</button>
          </div>`).join('')}
      </div>

      <div class="card">
        <h3>${t('pastOrders')}</h3>
        <div class="table-container" style="max-height:400px; overflow-y:auto">
          <table>
            <tr><th>User</th><th>Qty</th><th>Status</th><th>Date</th></tr>
            ${past.map(o => `<tr><td>${o.username}</td><td>${o.quantity}L</td><td style="color:green">${o.status}</td><td>${new Date(o.timestamp).toLocaleDateString()}</td></tr>`).join('')}
          </table>
        </div>
      </div>
    </div>
  `;
  renderDashboardShell(u, html, 'orders');
}

async function acceptOrder(id) {
  await fetch('/update-order', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, status:'Success'})});
  showToast("Order Accepted ‚úÖ"); adminOrders();
}

async function adminUsers() {
  const u = JSON.parse(localStorage.getItem('user'));
  const res = await fetch('/users'); 
  const users = await res.json();
  
  const html = `
    <h2>${t('users')}</h2>
    <div class="users-grid">
      ${users.map(usr => `
        <div class="user-box" onclick="editUser('${usr.username}')">
          <h3>User</h3>
          <h1>${usr.username}</h1>
        </div>`).join('')}
    </div>
  `;
  renderDashboardShell(u, html, 'users');
}

async function editUser(name) {
  const currUser = JSON.parse(localStorage.getItem('user'));
  const res = await fetch('/users'); const users = await res.json();
  const u = users.find(x => x.username === name);
  const sales = sortSalesByDate(u.sales);
  
  let st = { t2:0, t1:0, t34:0, t12:0, c2:0, c1:0, c34:0, c12:0, total:0 };
  u.sales.forEach(s => {
    st.t2 += s.twoL||0; st.c2 += (s.twoL||0)*PRICES.twoL;
    st.t1 += s.oneL||0; st.c1 += (s.oneL||0)*PRICES.oneL;
    st.t34 += s.threeQuarterL||0; st.c34 += (s.threeQuarterL||0)*PRICES.threeQuarterL;
    st.t12 += s.halfL||0; st.c12 += (s.halfL||0)*PRICES.halfL;
  });
  st.total = st.c2 + st.c1 + st.c34 + st.c12;

  const html = `
    <button class="btn-blue" onclick="adminUsers()" style="margin-bottom:15px">${t('back')}</button>
    <h2>Editing: ${name}</h2>
    
    <div class="grid-2">
      <div>
        <div class="card">
          <h3>Add Daily Entry</h3>
          <input type="date" id="d" style="width:100%">
          <br>
          <div style="display:flex; flex-wrap:wrap; justify-content:center">
             <button class="milk-btn" onclick="tog(this,'twoL')">2L</button>
             <button class="milk-btn" onclick="tog(this,'oneL')">1L</button>
             <button class="milk-btn" onclick="tog(this,'threeQuarterL')">3/4L</button>
             <button class="milk-btn" onclick="tog(this,'halfL')">1/2L</button>
          </div>
          <br>
          <button style="width:100%" onclick="save('${name}')">${t('save')}</button>
        </div>

        <div class="card" style="margin-top:20px;">
          <h3>Summary</h3>
          <div class="breakdown-item"><span>${t('q2')} (${st.t2})</span><span>‚Çπ${st.c2}</span></div>
          <div class="breakdown-item"><span>${t('q1')} (${st.t1})</span><span>‚Çπ${st.c1}</span></div>
          <div class="breakdown-item"><span>${t('q34')} (${st.t34})</span><span>‚Çπ${st.c34}</span></div>
          <div class="breakdown-item"><span>${t('q12')} (${st.t12})</span><span>‚Çπ${st.c12}</span></div>
          <div class="breakdown-item"><span>${t('grandTotal')}</span><span>‚Çπ${st.total}</span></div>
        </div>
      </div>

      <div class="card">
        <h3>Records</h3>
        <div class="table-container" style="max-height:400px; overflow-y:auto;">
          <table>
            <tr><th>Date</th><th>2L</th><th>1L</th><th>3/4</th><th>1/2</th><th>‚Çπ</th><th>Act</th></tr>
            ${sales.slice().reverse().map(s => {
               const cost = (s.twoL*140)+(s.oneL*70)+(s.threeQuarterL*55)+(s.halfL*35);
               return `
              <tr>
                <td>${s.date.split('/')[0]}/${s.date.split('/')[1]}</td>
                <td>${s.twoL||0}</td>
                <td>${s.oneL||0}</td>
                <td>${s.threeQuarterL||0}</td>
                <td>${s.halfL||0}</td>
                <td>${cost}</td>
                <td><button class="btn-red" onclick="del('${name}','${s.date}')">X</button></td>
              </tr>`}).join('')}
          </table>
        </div>
      </div>
    </div>
  `;
  renderDashboardShell(currUser, html, 'users');
}

// --- USER VIEWS ---

async function userProfile() {
  const u = JSON.parse(localStorage.getItem('user'));
  const html = `
    <h2>${t('profile')}</h2>
    
    <div class="grid-2">
      <div class="card">
        <h3 style="color:#555">${t('username')}</h3>
        <p style="font-size:1.5em; font-weight:bold; color:var(--primary)">${u.username}</p>
        <p style="color:#777">Role: User</p>
      </div>

      <div class="card">
        <h3>${t('changePassBtn')}</h3>
        <div class="pass-wrapper"><input id="oldP" type="password" placeholder="${t('oldPass')}"><span class="pass-icon" onclick="togglePass('oldP')">üëÅÔ∏è</span></div>
        <div class="pass-wrapper"><input id="newP" type="password" placeholder="${t('newPass')}"><span class="pass-icon" onclick="togglePass('newP')">üëÅÔ∏è</span></div>
        <button style="width:100%" onclick="changePass('${u.username}')">${t('save')}</button>
      </div>
    </div>
  `;
  renderDashboardShell(u, html, 'profile');
}

async function userOrders() {
  const u = JSON.parse(localStorage.getItem('user'));
  const res = await fetch(`/orders/${u.username}`); const orders = await res.json();
  
  const html = `
    <h2>${t('yourOrders')}</h2>
    
    <div class="grid-2">
      <div class="card">
        <h3>${t('placeOrderTitle')}</h3>
        <select id="oq" style="width:100%; padding:10px; margin-bottom:20px;">
          <option value="1">1 Litre</option>
          <option value="2">2 Litre</option>
          <option value="0.75">3/4 Litre</option>
          <option value="0.5">1/2 Litre</option>
        </select>
        <button style="width:100%" onclick="placeOrder('${u.username}')">${t('placeBtn')}</button>
      </div>

      <div class="card">
        <h3>${t('history')}</h3>
        ${orders.length === 0 ? '<p>No orders found.</p>' : ''}
        <div style="max-height:400px; overflow-y:auto">
          ${orders.map(o => `
            <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
               <span><b>${o.quantity}L</b> <br><small>${new Date(o.timestamp).toLocaleDateString()}</small></span>
               <span style="color:${o.status==='Pending'?'orange':'green'}; font-weight:bold">${o.status}</span>
            </div>`).join('')}
        </div>
      </div>
    </div>
  `;
  renderDashboardShell(u, html, 'orders');
}

async function userProgress() {
  const u = JSON.parse(localStorage.getItem('user'));
  const res = await fetch(`/user/${u.username}`); const data = await res.json();
  const grouped = {};
  data.sales.forEach(s => { const [d,m,y] = s.date.split('/'); const key = `${m}-${y}`; if(!grouped[key]) grouped[key] = []; grouped[key].push(s); });

  if(currentMonthView) {
    const sorted = sortSalesByDate(grouped[currentMonthView]);
    const st = calculateStats(sorted);
    const [m, y] = currentMonthView.split('-');
    const title = `${getMonthName(m)} ${y}`;

    const html = `
      <div style="display:flex; gap:10px; margin-bottom:15px; justify-content:space-between">
        <button class="btn-blue" onclick="currentMonthView=null; userProgress()">${t('back')}</button>
        <button style="background:#FF5722" onclick="downloadPDF('${title}')">${t('downloadPdf')}</button>
      </div>
      <h2>${title}</h2>

      <div class="card">
        <h3>${t('overview')}</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
           <p><b>${t('q2')}:</b> ${st.t2}</p> <p><b>‚Çπ:</b> ${st.cost2}</p>
           <p><b>${t('q1')}:</b> ${st.t1}</p> <p><b>‚Çπ:</b> ${st.cost1}</p>
           <p><b>${t('q34')}:</b> ${st.t34}</p> <p><b>‚Çπ:</b> ${st.cost34}</p>
           <p><b>${t('q12')}:</b> ${st.t12}</p> <p><b>‚Çπ:</b> ${st.cost12}</p>
        </div>
        <hr>
        <h3 style="color:var(--primary); text-align:right">${t('grandTotal')}: ‚Çπ${st.totalCost}</h3>
      </div>

      <div class="card" style="margin-top:20px">
        <div class="table-container">
            <table id="monthTable">
            <tr><th>${t('date')}</th><th>2L</th><th>1L</th><th>3/4</th><th>1/2</th><th>‚Çπ</th></tr>
            ${sorted.map(s => {
                const c=(s.twoL*140)+(s.oneL*70)+(s.threeQuarterL*55)+(s.halfL*35);
                return `<tr><td>${s.date}</td><td>${s.twoL||0}</td><td>${s.oneL||0}</td><td>${s.threeQuarterL||0}</td><td>${s.halfL||0}</td><td>${c}</td></tr>`
            }).join('')}
            </table>
        </div>
      </div>
    `;
    renderDashboardShell(u, html, 'progress');
  } else {
    const keys = Object.keys(grouped).sort().reverse();
    const html = `
      <h2>${t('progress')}</h2>
      ${keys.length === 0 ? '<p>No data available</p>' : ''}
      <div class="stats-grid">
        ${keys.map(k => {
          const [m, y] = k.split('-');
          return `<div class="month-card" onclick="currentMonthView='${k}'; userProgress()">üìÖ ${getMonthName(m)} ${y}</div>`;
        }).join('')}
      </div>
    `;
    renderDashboardShell(u, html, 'progress');
  }
}

// --- STANDARD USER HOME ---
async function userHome() {
  const u = JSON.parse(localStorage.getItem('user'));
  const res = await fetch(`/user/${u.username}`); const data = await res.json();
  
  let mData={};
  data.sales.forEach(s => { let m = s.date.split('/')[1]; mData[m] = (mData[m]||0) + (s.twoL*140)+(s.oneL*70)+(s.threeQuarterL*55)+(s.halfL*35); });
  
  renderDashboardShell(u, `<h1>${t('welcome')}</h1>`, 'home');
  
  const container = document.querySelector('.main-content');
  const chartDiv = document.createElement('div');
  chartDiv.className = 'grid-2';
  chartDiv.innerHTML = `<div class="card"><h3>Overview</h3><div style="position:relative; height:250px"><canvas id="pie"></canvas></div></div><div class="card"><h3>Monthly Revenue</h3><div style="position:relative; height:250px"><canvas id="bar"></canvas></div></div>`;
  container.appendChild(chartDiv);
  
  const ctx = document.getElementById('bar').getContext('2d');
  const grad = ctx.createLinearGradient(0,0,0,400); grad.addColorStop(0,'rgba(67, 160, 71, 0.6)'); grad.addColorStop(1,'rgba(67, 160, 71, 0.1)');
  new Chart(ctx, {type:'bar', data:{labels:Object.keys(mData).map(m=>getMonthName(m)), datasets:[{label:'Cost', data:Object.values(mData), backgroundColor:grad, borderRadius:5}]}, options:{maintainAspectRatio:false, scales:{y:{beginAtZero:true}}}});
  
  let t2=0,t1=0,t34=0,t12=0; data.sales.forEach(s=>{t2+=s.twoL||0;t1+=s.oneL||0;t34+=s.threeQuarterL||0;t12+=s.halfL||0;});
  new Chart(document.getElementById('pie'), {type:'doughnut', data:{labels:[t('q2'),t('q1'),t('q34'),t('q12')], datasets:[{data:[t2,t1,t34,t12], backgroundColor:['#43a047','#1976D2','#F57C00','#7B1FA2']}]}, options:{maintainAspectRatio:false}});
}

function userFeedback() {
  const u = JSON.parse(localStorage.getItem('user'));
  renderDashboardShell(u, `<h2>${t('feedbackTitle')}</h2><div class="card"><textarea style="width:100%; height:150px" placeholder="${t('feedbackPlace')}"></textarea><button style="width:100%">${t('submitBtn')}</button></div>`, 'feedback');
}

// --- ACTIONS ---
function tog(b,t){b.classList.toggle('active');selectedMilk[t]=selectedMilk[t]?0:1;}
async function save(n){const d=document.getElementById('d').value;if(!d)return;const[y,m,day]=d.split('-');await fetch('/add-sale',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:n,sale:{date:`${day}/${m}/${y}`,...selectedMilk}})});selectedMilk={twoL:0,oneL:0,threeQuarterL:0,halfL:0};showToast(t('save')+" ‚úÖ");editUser(n);}
async function del(n,d){await fetch('/delete-sale',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:n,date:d})});showToast(t('delete')+" ‚úÖ");editUser(n);}
async function changePass(u){const o=document.getElementById('oldP').value,n=document.getElementById('newP').value;const r=await fetch('/change-password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,oldPassword:o,newPassword:n})});const d=await r.json();d.success?(showToast('Success'),userProfile()):alert(d.error);}
async function placeOrder(u){const q=document.getElementById('oq').value;await fetch('/place-order',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,quantity:q})});showToast('Order Placed');userOrders();}
function downloadPDF(title){const {jsPDF}=window.jspdf;const doc=new jsPDF();doc.text(title,14,20);doc.autoTable({html:'#monthTable',startY:30});doc.save(title+'.pdf');}
async function login(){const u=document.getElementById('u').value,p=document.getElementById('p').value;const r=await fetch('/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});const d=await r.json();if(!d)return alert('Invalid');localStorage.setItem('user',JSON.stringify({username:u,role:d.role}));d.role==='admin'?adminSummary():userHome();}
async function register(){const u=document.getElementById('ru').value,p=document.getElementById('rp').value;await fetch('/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});alert('Registered');location.reload();}
function logout(){localStorage.clear();renderAuth();}
function toggleAuth(v){document.getElementById('loginForm').style.display=v==='login'?'block':'none';document.getElementById('regForm').style.display=v==='reg'?'block':'none';}
function togglePass(id){const x=document.getElementById(id);x.type=x.type==='password'?'text':'password';}
    
// --- AUTH RENDER ---
function renderAuth(){app.innerHTML=`<div class="auth-container">${renderControls()}<div class="auth-box"><h1 style="color:#43a047">üåæ ‡∞∞‡±à‡∞§‡±Å ‡∞™‡∞æ‡∞≤‡±Å</h1><div id="loginForm"><h2>${t('login')}</h2><input id="u" placeholder="${t('username')}"><div class="pass-wrapper"><input id="p" type="password" placeholder="${t('password')}"><span class="pass-icon" onclick="togglePass('p')">üëÅÔ∏è</span></div><button style="width:100%" onclick="login()">${t('login')}</button><p onclick="toggleAuth('reg')" style="cursor:pointer;color:blue;margin-top:10px">${t('register')}</p></div><div id="regForm" style="display:none"><h2>${t('register')}</h2><input id="ru" placeholder="${t('username')}"><div class="pass-wrapper"><input id="rp" type="password" placeholder="${t('password')}"><span class="pass-icon" onclick="togglePass('rp')">üëÅÔ∏è</span></div><button style="width:100%" onclick="register()">${t('register')}</button><p onclick="toggleAuth('login')" style="cursor:pointer;color:blue;margin-top:10px">${t('login')}</p></div></div></div>`;}

// INIT
const saved=JSON.parse(localStorage.getItem('user'));
if(saved) saved.role==='admin'?adminSummary():userHome(); else renderAuth();
</script>
</body>
</html>