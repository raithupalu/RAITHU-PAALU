<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>‡∞∞‡±à‡∞§‡±Å ‡∞™‡∞æ‡∞≤‡±Å | Premium Farm App</title>
  
  <!-- Modern Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  
  <style>
    :root {
      --primary: #10b981;
      --primary-dark: #047857;
      --accent: #34d399;
      --surface: rgba(255, 255, 255, 0.75);
      --surface-border: rgba(255, 255, 255, 0.6);
      --blur: 24px;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
      --text-main: #111827;
      --text-sub: #6b7280;
      --radius: 24px;
    }

    .dark-mode {
      --primary: #34d399;
      --primary-dark: #059669;
      --surface: rgba(15, 23, 42, 0.75);
      --surface-border: rgba(255, 255, 255, 0.08);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      --text-main: #f9fafb;
      --text-sub: #9ca3af;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    
    body { 
      margin: 0; font-family: 'Manrope', sans-serif; 
      color: var(--text-main); height: 100vh; overflow: hidden; 
      background: #f0fdf4;
      transition: background 0.5s;
    }
    .dark-mode body { background: #020617; }

    /* --- LIVING BACKGROUND --- */
    .blob {
      position: absolute; filter: blur(80px); opacity: 0.6; z-index: -1;
      animation: float 20s infinite ease-in-out alternate;
    }
    .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: #86efac; border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; }
    .blob-2 { bottom: -10%; right: -10%; width: 400px; height: 400px; background: #6ee7b7; border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; animation-delay: -5s; }
    .dark-mode .blob-1 { background: #064e3b; opacity: 0.4; }
    .dark-mode .blob-2 { background: #065f46; opacity: 0.4; }

    @keyframes float { 0% { transform: translate(0, 0) rotate(0deg); } 100% { transform: translate(50px, 50px) rotate(20deg); } }

    /* --- LAYOUT --- */
    .dashboard-container { display: flex; width: 100%; height: 100%; }
    
    /* GLASS SIDEBAR */
    .sidebar { 
      width: 280px; padding: 40px 25px; 
      display: flex; flex-direction: column; 
      background: var(--surface); backdrop-filter: blur(var(--blur));
      border-right: 1px solid var(--surface-border);
      z-index: 50; transition: 0.3s;
    }
    
    .logo { 
      font-size: 28px; font-weight: 800; margin-bottom: 50px; 
      background: linear-gradient(135deg, var(--primary), #059669);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      display: flex; align-items: center; gap: 10px;
    }
    
    .sidebar-btn {
      padding: 16px 20px; margin-bottom: 12px; border-radius: 18px; 
      cursor: pointer; display: flex; align-items: center; gap: 16px; 
      font-weight: 600; font-size: 15px; color: var(--text-sub);
      transition: all 0.3s;
    }
    .sidebar-btn:hover { background: rgba(16, 185, 129, 0.08); color: var(--primary); transform: translateX(5px); }
    .sidebar-btn.active { 
      background: var(--primary); color: white; 
      box-shadow: 0 10px 25px -5px rgba(16, 185, 129, 0.4);
    }
    .sidebar-btn span { font-size: 20px; }

    /* MAIN CONTENT */
    .main-content { flex: 1; padding: 40px; overflow-y: auto; position: relative; scroll-behavior: smooth; }
    
    .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .greeting-box h1 { margin: 0; font-size: 2rem; font-weight: 800; letter-spacing: -0.5px; }
    .greeting-box p { margin: 5px 0 0 0; color: var(--text-sub); font-weight: 500; }
    
    .controls { display: flex; gap: 12px; }
    .control-btn {
      width: 44px; height: 44px; border-radius: 50%; border: 1px solid var(--surface-border);
      background: var(--surface); display: flex; align-items: center; justify-content: center;
      font-size: 18px; cursor: pointer; transition: 0.2s;
    }
    .control-btn:hover { transform: scale(1.1); background: white; }

    /* BENTO GRID */
    .bento-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 24px; padding-bottom: 40px; }
    .col-12 { grid-column: span 12; }
    .col-8 { grid-column: span 8; }
    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    .col-3 { grid-column: span 3; }
    
    .card {
      background: var(--surface); border: 1px solid var(--surface-border);
      backdrop-filter: blur(var(--blur)); border-radius: var(--radius);
      padding: 24px; box-shadow: var(--shadow);
      transition: transform 0.3s, box-shadow 0.3s;
      position: relative; overflow: hidden; display: flex; flex-direction: column;
    }
    .card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px -10px rgba(0,0,0,0.1); }
    
    /* Typography within Cards */
    .card h3 { margin: 0 0 15px 0; font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
    .stat-val { font-size: 2.2rem; font-weight: 800; color: var(--text-main); margin: 5px 0; }
    .stat-label { color: var(--text-sub); font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-badge { font-size: 0.8rem; background: rgba(16, 185, 129, 0.1); color: #10b981; padding: 4px 10px; border-radius: 20px; display: inline-block; font-weight: 700; margin-bottom: 5px; }

    /* Month Card */
    .month-box {
      cursor: pointer; text-align: center; padding: 20px;
      transition: 0.2s; border: 2px solid transparent;
      background: rgba(255,255,255,0.4); border-radius: 20px;
    }
    .month-box:hover { background: white; border-color: var(--primary); transform: scale(1.05); }
    
    /* Interactive Elements */
    .milk-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: auto; }
    .milk-btn {
      background: rgba(255,255,255,0.5); border: 2px solid transparent; padding: 12px;
      border-radius: 16px; cursor: pointer; text-align: center; transition: 0.2s;
      font-weight: 700; color: var(--text-main); font-size: 0.9rem;
    }
    .milk-btn.active { background: var(--primary); color: white; transform: scale(0.96); box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }

    /* Tables */
    .table-wrapper { width: 100%; overflow-x: auto; border-radius: 16px; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 500px; }
    th { text-align: left; padding: 16px; color: var(--text-sub); font-size: 12px; text-transform: uppercase; border-bottom: 2px solid rgba(0,0,0,0.05); background: rgba(0,0,0,0.02); }
    td { padding: 16px; border-bottom: 1px solid rgba(0,0,0,0.03); font-weight: 600; }
    tr:last-child td { border: none; }
    
    /* Buttons */
    .btn-main {
      width: 100%; padding: 16px; border: none; border-radius: 16px;
      background: linear-gradient(135deg, var(--primary), #059669);
      color: white; font-size: 15px; font-weight: 700; cursor: pointer;
      box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.4);
      transition: 0.3s;
    }
    .btn-main:hover { transform: translateY(-2px); box-shadow: 0 15px 30px -5px rgba(16, 185, 129, 0.5); }
    .btn-sec {
      background: transparent; border: 2px solid var(--text-sub); color: var(--text-main);
      padding: 8px 16px; border-radius: 12px; cursor: pointer; font-weight: 600;
    }

    /* --- MOBILE DOCK --- */
    @media (max-width: 1000px) { .bento-grid { grid-template-columns: repeat(2, 1fr); } .col-12, .col-8, .col-6, .col-4, .col-3 { grid-column: span 2; } }

    @media (max-width: 768px) {
      .dashboard-container { flex-direction: column; }
      .sidebar { display: none; }
      
      .mobile-nav {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        width: 90%; max-width: 400px; height: 70px;
        background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.5); border-radius: 35px;
        display: flex; justify-content: space-around; align-items: center;
        z-index: 999; box-shadow: 0 15px 40px -10px rgba(0,0,0,0.2);
      }
      .dark-mode .mobile-nav { background: rgba(15, 23, 42, 0.9); border-color: rgba(255,255,255,0.1); }
      
      .nav-icon { font-size: 24px; padding: 12px; border-radius: 50%; color: var(--text-sub); transition: 0.3s; }
      .nav-icon.active { background: var(--primary); color: white; transform: translateY(-10px); box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.5); }
      
      .main-content { padding: 20px; padding-bottom: 100px; }
      .header-bar { flex-direction: column; align-items: flex-start; gap: 15px; }
      .controls { width: 100%; justify-content: flex-end; }
      
      .bento-grid { display: flex; flex-direction: column; gap: 20px; }
      .col-12, .col-8, .col-6, .col-4, .col-3 { grid-column: span 1; }
    }
    
    /* AUTH */
    .auth-wrap { width: 100%; height: 100vh; display: flex; align-items: center; justify-content: center; background: url('https://images.unsplash.com/photo-1595414088017-d2e825e37894?q=80&w=2070&auto=format&fit=crop') center/cover; }
    .auth-glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(25px); padding: 40px; border-radius: 32px; width: 90%; max-width: 420px; text-align: center; box-shadow: 0 40px 80px -20px rgba(0,0,0,0.5); }
    input { width: 100%; padding: 16px; margin-bottom: 16px; border-radius: 16px; border: 2px solid transparent; background: rgba(255,255,255,0.7); font-size: 16px; font-weight: 600; color: var(--text-main); }
    input:focus { background: white; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1); }

  </style>
</head>
<body>

<div class="blob blob-1"></div>
<div class="blob blob-2"></div>

<div id="app" style="width:100%; height:100%"></div>
<div id="toast" style="visibility:hidden; min-width:200px; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px); color:white; text-align:center; border-radius:50px; padding:12px 24px; position:fixed; z-index:9999; left:50%; top:20px; transform:translateX(-50%); font-weight:600; box-shadow: 0 10px 30px rgba(0,0,0,0.2);"></div>

<script>
// --- CONFIG & STATE ---
const PRICES = { twoL: 140, oneL: 70, threeQuarterL: 55, halfL: 35 };
let currentLang = localStorage.getItem('lang') || 'en';
let currentTheme = localStorage.getItem('theme') || 'light';
let selectedMilk = { twoL: 0, oneL: 0, threeQuarterL: 0, halfL: 0 };
let currentMonthView = null;
if(currentTheme === 'dark') document.body.classList.add('dark-mode');

const T = {
  en: { greet: "Good", dash: "Overview", orders: "Orders", progress: "Progress", profile: "Profile", logout: "Logout", total: "Total Bill", active: "Active Days", req: "Request Milk", sub: "Submit Order", back: "Back", download: "Download PDF", revenue: "Total Revenue", farmers: "Farmers", manage: "Manage" },
  te: { greet: "‡∞®‡∞Æ‡∞∏‡±ç‡∞ï‡∞æ‡∞∞‡∞Ç", dash: "‡∞π‡±ã‡∞Æ‡±ç", orders: "‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç‡∞≤‡±Å", progress: "‡∞™‡±Å‡∞∞‡±ã‡∞ó‡∞§‡∞ø", profile: "‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç", logout: "‡∞µ‡±Ü‡∞≥‡±ç‡∞≤‡±Å", total: "‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç", active: "‡∞∞‡±ã‡∞ú‡±Å‡∞≤‡±Å", req: "‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø", sub: "‡∞™‡∞Ç‡∞™‡∞Ç‡∞°‡∞ø", back: "‡∞µ‡±Ü‡∞®‡±Å‡∞ï‡∞ï‡±Å", download: "‡∞∞‡∞ø‡∞™‡±ã‡∞∞‡±ç‡∞ü‡±ç", revenue: "‡∞Ü‡∞¶‡∞æ‡∞Ø‡∞Ç", farmers: "‡∞∞‡±à‡∞§‡±Å‡∞≤‡±Å", manage: "‡∞®‡∞ø‡∞∞‡±ç‡∞µ‡∞π‡∞ø‡∞Ç‡∞ö‡±Å" },
  hi: { greet: "‡§®‡§Æ‡§∏‡•ç‡§§‡•á", dash: "‡§π‡•ã‡§Æ", orders: "‡§Ü‡§∞‡•ç‡§°‡§∞", progress: "‡§™‡•ç‡§∞‡§ó‡§§‡§ø", profile: "‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤", logout: "‡§¨‡§æ‡§π‡§∞", total: "‡§ï‡•Å‡§≤", active: "‡§¶‡§ø‡§®", req: "‡§ë‡§∞‡•ç‡§°‡§∞ ‡§¶‡•á‡§Ç", sub: "‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç", back: "‡§™‡•Ä‡§õ‡•á", download: "‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü", revenue: "‡§∞‡§æ‡§ú‡§∏‡•ç‡§µ", farmers: "‡§ï‡§ø‡§∏‡§æ‡§®", manage: "‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®" }
};
const t = (k) => T[currentLang][k] || k;
const app = document.getElementById("app");

// --- UTILS ---
function getGreeting() { const h = new Date().getHours(); const time = h < 12 ? "Morning ‚òÄÔ∏è" : h < 18 ? "Afternoon üå§Ô∏è" : "Evening üåô"; return `${t('greet')} ${currentLang==='en'?time:''}`; }
function setLang(l) { localStorage.setItem('lang', l); location.reload(); }
function toggleTheme() { currentTheme = currentTheme==='light'?'dark':'light'; localStorage.setItem('theme', currentTheme); document.body.classList.toggle('dark-mode'); document.getElementById('themeIcon').innerText = currentTheme==='light'?'üåô':'‚òÄÔ∏è'; }
function showToast(m) { const x=document.getElementById("toast"); x.style.visibility="visible"; x.innerText=m; setTimeout(()=>x.style.visibility="hidden",3000); }
function fireConfetti() { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#10b981', '#34d399', '#ffffff'] }); }
function getMonthName(m) { return ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][parseInt(m)-1]; }
function sortSalesByDate(sales) { return sales.sort((a, b) => { const [d1, m1, y1] = a.date.split('/'); const [d2, m2, y2] = b.date.split('/'); return new Date(y1, m1-1, d1) - new Date(y2, m2-1, d2); }); }
function calculateStats(sales) { let s={t2:0, t1:0, t34:0, t12:0, days:sales.length, total:0}; sales.forEach(x => { s.t2+=x.twoL||0; s.t1+=x.oneL||0; s.t34+=x.threeQuarterL||0; s.t12+=x.halfL||0; s.total += (x.twoL*PRICES.twoL)+(x.oneL*PRICES.oneL)+(x.threeQuarterL*PRICES.threeQuarterL)+(x.halfL*PRICES.halfL); }); return s; }

// --- SHELL ---
function renderShell(user, content, tab) {
  const role = user.role;
  const menu = role === 'admin' 
    ? [{k:'summary', i:'üìä', l:t('dash'), f:'adminSummary()'}, {k:'orders', i:'üì¶', l:t('orders'), f:'adminOrders()'}, {k:'users', i:'üë•', l:t('farmers'), f:'adminUsers()'}]
    : [{k:'home', i:'üè†', l:t('dash'), f:'userHome()'}, {k:'progress', i:'üìà', l:t('progress'), f:'userProgress()'}, {k:'orders', i:'üõí', l:t('orders'), f:'userOrders()'}, {k:'profile', i:'üë§', l:t('profile'), f:'userProfile()'}];

  const sidebar = menu.map(m => `<div class="sidebar-btn ${tab===m.k?'active':''}" onclick="${m.f}"><span>${m.i}</span>${m.l}</div>`).join('');
  const mobileNav = menu.map(m => `<div class="nav-icon ${tab===m.k?'active':''}" onclick="${m.f}">${m.i}</div>`).join('') + `<div class="nav-icon" style="color:#ef4444" onclick="logout()">üõë</div>`;

  app.innerHTML = `
    <div class="dashboard-container">
      <div class="sidebar">
        <div class="logo">üåæ <span>‡∞∞‡±à‡∞§‡±Å ‡∞™‡∞æ‡∞≤‡±Å</span></div>
        ${sidebar}
        <div class="sidebar-btn" style="margin-top:auto; color:#ef4444" onclick="logout()"><span>üõë</span> ${t('logout')}</div>
      </div>
      <div class="main-content">
        <div class="header-bar">
          <div class="greeting-box"><h1>${getGreeting()}</h1><p>${user.username}</p></div>
          <div class="controls">
            <button class="control-btn" onclick="toggleTheme()" id="themeIcon">${currentTheme==='light'?'üåô':'‚òÄÔ∏è'}</button>
            <select style="width:auto; margin:0; padding:10px; border-radius:20px; border:none; background:var(--surface)" onchange="setLang(this.value)"><option value="en" ${currentLang==='en'?'selected':''}>EN</option><option value="te" ${currentLang==='te'?'selected':''}>TE</option><option value="hi" ${currentLang==='hi'?'selected':''}>HI</option></select>
          </div>
        </div>
        ${content}
      </div>
      <div class="mobile-nav display-none-desktop">${mobileNav}</div>
      <style>@media(min-width:769px){.display-none-desktop{display:none}}</style>
    </div>`;
}

// --- USER DASHBOARD (HOME) ---
async function userHome() {
  const u = JSON.parse(localStorage.getItem('user')); const res = await fetch(`/user/${u.username}`); const data = await res.json();
  const st = calculateStats(data.sales);
  let mData={}; data.sales.forEach(s => { let m=s.date.split('/')[1]; mData[m]=(mData[m]||0)+(s.twoL*140)+(s.oneL*70)+(s.threeQuarterL*55)+(s.halfL*35); });

  renderShell(u, `
    <div class="bento-grid">
      <div class="card col-4">
        <div class="stat-badge">Overview</div>
        <div class="stat-val">‚Çπ${st.total.toLocaleString()}</div>
        <div class="stat-label">${t('total')}</div>
      </div>
      <div class="card col-4">
        <div class="stat-badge">Activity</div>
        <div class="stat-val">${st.days}</div>
        <div class="stat-label">${t('active')}</div>
      </div>
      <div class="card col-4" style="background:linear-gradient(135deg, var(--primary), #059669); color:white">
         <div style="font-size:2rem; margin-bottom:5px">ü•õ</div>
         <div style="font-weight:700;">Need Milk?</div>
         <button class="btn-main" style="background:white; color:var(--primary); margin-top:auto; padding:10px" onclick="userOrders()">${t('req')} ‚ûî</button>
      </div>
      <div class="card col-8">
        <h3>Monthly Spend</h3>
        <div style="height:250px"><canvas id="mainChart"></canvas></div>
      </div>
      <div class="card col-4">
         <h3>Consumption</h3>
         <div style="height:200px; display:flex; justify-content:center"><canvas id="pieChart"></canvas></div>
      </div>
    </div>
  `, 'home');

  new Chart(document.getElementById('mainChart'), {type:'line', data:{labels:Object.keys(mData).map(m=>getMonthName(m)), datasets:[{label:'Spend', data:Object.values(mData), borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.1)', fill:true, tension:0.4, pointRadius:5}]}, options:{plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{grid:{display:false}}}}});
  new Chart(document.getElementById('pieChart'), {type:'doughnut', data:{labels:['2L','1L','3/4L','1/2L'], datasets:[{data:[st.t2, st.t1, st.t34, st.t12], backgroundColor:['#064e3b','#065f46','#10b981','#6ee7b7'], borderWidth:0}]}});
}

// --- USER PROGRESS (RESTORED) ---
async function userProgress() {
  const u = JSON.parse(localStorage.getItem('user')); const res = await fetch(`/user/${u.username}`); const data = await res.json();
  const grouped = {}; data.sales.forEach(s => { const [d,m,y] = s.date.split('/'); const key = `${m}-${y}`; if(!grouped[key]) grouped[key] = []; grouped[key].push(s); });
  
  if (currentMonthView) {
    const sorted = sortSalesByDate(grouped[currentMonthView]);
    const st = calculateStats(sorted);
    const [m, y] = currentMonthView.split('-');
    
    renderShell(u, `
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
        <button class="btn-sec" onclick="currentMonthView=null; userProgress()">‚¨Ö ${t('back')}</button>
        <button class="btn-main" style="width:auto; padding:10px 20px" onclick="downloadPDF('${getMonthName(m)} ${y}')">${t('download')}</button>
      </div>
      <div class="bento-grid">
         <div class="card col-4" style="text-align:center">
            <h3>${getMonthName(m)} ${y}</h3>
            <div class="stat-val" style="color:var(--primary)">‚Çπ${st.total}</div>
            <p style="color:var(--text-sub)">${st.days} Days Active</p>
         </div>
         <div class="card col-8">
            <div class="table-wrapper">
               <table id="pdfTable">
                 <tr><th>Date</th><th>Qty</th><th>Cost</th></tr>
                 ${sorted.map(s => `<tr><td>${s.date}</td><td>${s.twoL?'2L ':''}${s.oneL?'1L ':''}${s.threeQuarterL?'3/4L ':''}${s.halfL?'1/2L':''}</td><td>‚Çπ${(s.twoL*140)+(s.oneL*70)+(s.threeQuarterL*55)+(s.halfL*35)}</td></tr>`).join('')}
               </table>
            </div>
         </div>
      </div>
    `, 'progress');
  } else {
    renderShell(u, `
       <div class="bento-grid">
         <div class="card col-12"><h3>Select a Month</h3><p style="color:var(--text-sub)">Tap to view details</p></div>
         ${Object.keys(grouped).length === 0 ? '<div class="card col-12">No records found.</div>' : ''}
         ${Object.keys(grouped).reverse().map(k => `
            <div class="card col-3 month-box" onclick="currentMonthView='${k}'; userProgress()">
               <div style="font-size:30px; margin-bottom:10px">üìÖ</div>
               <div style="font-weight:700; font-size:1.1rem">${getMonthName(k.split('-')[0])}</div>
               <div style="color:var(--text-sub)">${k.split('-')[1]}</div>
            </div>
         `).join('')}
       </div>
    `, 'progress');
  }
}

// --- ADMIN SUMMARY (RESTORED TOTALS) ---
async function adminSummary() {
  const u = JSON.parse(localStorage.getItem('user')); const res = await fetch('/users'); const users = await res.json();
  let rev=0, sold={t2:0,t1:0,t34:0,t12:0};
  users.forEach(u=>u.sales.forEach(s=> {
     rev+=(s.twoL*140)+(s.oneL*70)+(s.threeQuarterL*55)+(s.halfL*35);
     sold.t2+=s.twoL||0; sold.t1+=s.oneL||0; sold.t34+=s.threeQuarterL||0; sold.t12+=s.halfL||0;
  }));
  
  renderShell(u, `
    <div class="bento-grid">
      <div class="card col-6">
        <div class="stat-badge">Total Revenue</div>
        <div class="stat-val">‚Çπ${rev.toLocaleString()}</div>
      </div>
      <div class="card col-6">
        <div class="stat-badge">Farmers</div>
        <div class="stat-val">${users.length}</div>
      </div>
      <div class="card col-3"><div class="stat-val" style="font-size:1.5rem">${sold.t2}</div><div class="stat-label">2L Packets</div></div>
      <div class="card col-3"><div class="stat-val" style="font-size:1.5rem">${sold.t1}</div><div class="stat-label">1L Packets</div></div>
      <div class="card col-3"><div class="stat-val" style="font-size:1.5rem">${sold.t34}</div><div class="stat-label">3/4L Packets</div></div>
      <div class="card col-3"><div class="stat-val" style="font-size:1.5rem">${sold.t12}</div><div class="stat-label">1/2L Packets</div></div>
    </div>
  `, 'summary');
}

// --- ADMIN USER MANAGEMENT ---
async function adminUsers() {
  const u = JSON.parse(localStorage.getItem('user')); const res = await fetch('/users'); const users = await res.json();
  renderShell(u, `
    <div class="bento-grid">
      ${users.map(usr => `
        <div class="card col-4" onclick="editUser('${usr.username}')" style="cursor:pointer; text-align:center">
           <div style="font-size:40px; margin-bottom:10px">üë®‚Äçüåæ</div>
           <h3>${usr.username}</h3>
           <p style="color:var(--text-sub); font-size:12px">Tap to Manage</p>
        </div>
      `).join('')}
    </div>
  `, 'users');
}

async function editUser(name) {
  const u = JSON.parse(localStorage.getItem('user')); const res = await fetch('/users'); const users = await res.json();
  const target = users.find(x => x.username === name);
  const st = calculateStats(target.sales);
  
  renderShell(u, `
    <button class="btn-sec" onclick="adminUsers()" style="margin-bottom:20px">‚¨Ö ${t('back')}</button>
    <div class="bento-grid">
      <div class="card col-6">
        <h3>Add Entry: ${name}</h3>
        <input type="date" id="d" style="background:var(--surface); border:1px solid var(--surface-border)">
        <div class="milk-grid">
           <div class="milk-btn" onclick="tog(this,'twoL')">2 L</div><div class="milk-btn" onclick="tog(this,'oneL')">1 L</div>
           <div class="milk-btn" onclick="tog(this,'threeQuarterL')">0.75 L</div><div class="milk-btn" onclick="tog(this,'halfL')">0.5 L</div>
        </div>
        <button class="btn-main" onclick="save('${name}')">${t('save')}</button>
      </div>
      <div class="card col-6">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px">
           <span>Total: <b>‚Çπ${st.total}</b></span><span>Entries: <b>${st.days}</b></span>
        </div>
        <div class="table-wrapper" style="max-height:400px; overflow-y:auto">
           <table>
             ${target.sales.slice().reverse().map(s => `<tr><td>${s.date}</td><td>‚Çπ${(s.twoL*140)+(s.oneL*70)+(s.threeQuarterL*55)+(s.halfL*35)}</td><td style="color:red; cursor:pointer" onclick="del('${name}','${s.date}')">‚úï</td></tr>`).join('')}
           </table>
        </div>
      </div>
    </div>
  `, 'users');
}

// --- ORDERS ---
async function userOrders() {
  const u = JSON.parse(localStorage.getItem('user')); const res = await fetch(`/orders/${u.username}`); const orders = await res.json();
  renderShell(u, `
    <div class="bento-grid">
      <div class="card col-5">
        <h3>${t('req')}</h3>
        <select id="oq" style="width:100%; padding:15px; border-radius:15px; border:1px solid #ddd; margin-bottom:20px">
           <option value="1">1 Litre</option><option value="2">2 Litres</option><option value="0.5">0.5 Litre</option>
        </select>
        <button class="btn-main" onclick="placeOrder('${u.username}')">${t('sub')}</button>
      </div>
      <div class="card col-7">
        <h3>History</h3>
        <div class="table-wrapper" style="max-height:300px; overflow-y:auto">
           <table>
             ${orders.map(o => `<tr><td>${new Date(o.timestamp).toLocaleDateString()}</td><td>${o.quantity}L</td><td><span style="color:${o.status==='Pending'?'orange':'#10b981'}">${o.status}</span></td></tr>`).join('')}
           </table>
        </div>
      </div>
    </div>
  `, 'orders');
}

async function adminOrders() {
  const u = JSON.parse(localStorage.getItem('user')); const res = await fetch('/orders'); const orders = await res.json();
  const pending = orders.filter(o => o.status === 'Pending');
  renderShell(u, `
    <div class="bento-grid">
       ${pending.map(o => `
         <div class="card col-4">
           <h3>${o.username}</h3>
           <div class="stat-val" style="font-size:1.5rem">${o.quantity}L</div>
           <p>${new Date(o.timestamp).toLocaleString()}</p>
           <button class="btn-main" onclick="acceptOrder('${o.id}')">Approve ‚úÖ</button>
         </div>
       `).join('')}
       ${pending.length===0 ? '<div class="card col-12"><p style="text-align:center">No pending orders üéâ</p></div>' : ''}
    </div>
  `, 'orders');
}

// --- PROFILE ---
function userProfile() {
  const u = JSON.parse(localStorage.getItem('user'));
  renderShell(u, `
    <div class="card" style="max-width:500px; margin:0 auto; text-align:center">
       <div style="width:80px; height:80px; background:#d1fae5; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:40px; margin:0 auto 20px auto">üë§</div>
       <h2>${u.username}</h2>
       <input id="oldP" type="password" placeholder="Old Password">
       <input id="newP" type="password" placeholder="New Password">
       <button class="btn-main" onclick="changePass('${u.username}')">Update Password</button>
    </div>
  `, 'profile');
}

// --- LOGIC ---
function tog(b,t){b.classList.toggle('active');selectedMilk[t]=selectedMilk[t]?0:1;}
async function save(n){const d=document.getElementById('d').value;if(!d)return;const[y,m,day]=d.split('-');await fetch('/add-sale',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:n,sale:{date:`${day}/${m}/${y}`,...selectedMilk}})});selectedMilk={twoL:0,oneL:0,threeQuarterL:0,halfL:0};fireConfetti();showToast("Entry Added ‚ú®");editUser(n);}
async function del(n,d){await fetch('/delete-sale',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:n,date:d})});showToast("Deleted");editUser(n);}
async function changePass(u){const o=document.getElementById('oldP').value,n=document.getElementById('newP').value;const r=await fetch('/change-password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,oldPassword:o,newPassword:n})});const d=await r.json();d.success?(fireConfetti(),showToast('Success'),userProfile()):alert(d.error);}
async function placeOrder(u){const q=document.getElementById('oq').value;await fetch('/place-order',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,quantity:q})});fireConfetti();showToast('Order Sent üöÄ');userOrders();}
async function acceptOrder(id){await fetch('/update-order', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, status:'Success'})}); fireConfetti(); adminOrders();}
function downloadPDF(title){const {jsPDF}=window.jspdf;const doc=new jsPDF();doc.text(title,14,20);doc.autoTable({html:'#pdfTable',startY:30});doc.save(title+'.pdf');}
async function login(){const u=document.getElementById('u').value,p=document.getElementById('p').value;const r=await fetch('/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});const d=await r.json();if(!d)return alert('Invalid');localStorage.setItem('user',JSON.stringify({username:u,role:d.role}));d.role==='admin'?adminSummary():userHome();}
async function register(){const u=document.getElementById('ru').value,p=document.getElementById('rp').value;await fetch('/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});alert('Registered');location.reload();}
function logout(){localStorage.clear();renderAuth();}
function toggleAuth(v){document.getElementById('loginForm').style.display=v==='login'?'block':'none';document.getElementById('regForm').style.display=v==='reg'?'block':'none';}
function togglePass(id){const x=document.getElementById(id);x.type=x.type==='password'?'text':'password';}

// --- LOGIN SCREEN ---
function renderAuth(){
  app.innerHTML = `
    <div class="auth-wrap">
      <div class="auth-glass">
        <div style="font-size:50px; margin-bottom:20px">üåæ</div>
        <h1 style="margin:0; color:var(--primary-dark)">${t('welcome')}</h1>
        <p style="color:#666; margin-bottom:30px">Premium Farm Management</p>
        <div id="loginForm">
           <input id="u" placeholder="Username">
           <div style="position:relative"><input id="p" type="password" placeholder="Password"><span style="position:absolute; right:15px; top:15px; cursor:pointer" onclick="togglePass('p')">üëÅÔ∏è</span></div>
           <button class="btn-main" onclick="login()">Login</button>
           <p style="margin-top:20px; cursor:pointer; font-weight:700; color:var(--primary)" onclick="toggleAuth('reg')">Create Account</p>
        </div>
        <div id="regForm" style="display:none">
           <input id="ru" placeholder="Username">
           <div style="position:relative"><input id="rp" type="password" placeholder="Password"><span style="position:absolute; right:15px; top:15px; cursor:pointer" onclick="togglePass('rp')">üëÅÔ∏è</span></div>
           <button class="btn-main" onclick="register()">Sign Up</button>
           <p style="margin-top:20px; cursor:pointer; font-weight:700; color:var(--primary)" onclick="toggleAuth('login')">Back to Login</p>
        </div>
      </div>
    </div>`;
}

// INIT
const saved=JSON.parse(localStorage.getItem('user'));
if(saved) saved.role==='admin'?adminSummary():userHome(); else renderAuth();
</script>
</body>
</html>