<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>‡∞∞‡±à‡∞§‡±Å ‡∞™‡∞æ‡∞≤‡±Å | Premium Farm App</title>
  
  <!-- Modern Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" href="/favicon.ico" />
  
 <!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    /* ================================
   ROOT VARIABLES - ENHANCED
================================ */
:root {
  --primary: #10b981;
  --primary-dark: #047857;
  --primary-light: #d1fae5;
  --accent: #34d399;
  --accent-glow: rgba(52, 211, 153, 0.3);
  --surface: rgba(255,255,255,0.85);
  --surface-border: rgba(16,185,129,0.15);
  --text-main: #111827;
  --text-sub: #6b7280;
  --radius: 20px;
  --shadow: 0 8px 32px rgba(16,185,129,0.12);
  --shadow-hover: 0 12px 40px rgba(16,185,129,0.2);
  --gradient-primary: linear-gradient(135deg, #10b981 0%, #059669 100%);
  --gradient-soft: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
}
.main-content > *:first-child {
  margin-top: 0;
}
@media (max-width: 900px) {
  .header-bar {
    flex-direction: column;
    align-items: flex-start;
    gap: 16px;
  }
}

.dark-mode {
  --surface: rgba(15,23,42,0.85);
  --surface-border: rgba(255,255,255,0.1);
  --text-main: #f9fafb;
  --text-sub: #9ca3af;
  --shadow: 0 8px 32px rgba(0,0,0,0.4);
}
.notify-panel {
  position:absolute;
  top:56px;
  right:0;
  width:280px;
  background:var(--surface);
  border:1px solid var(--surface-border);
  border-radius:16px;
  box-shadow:var(--shadow);
  display:none;
  padding:12px;
  z-index:9999;
}

.notify-panel.active {
  display:block;
}

.dock-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: none;
  border: none;
  color: var(--text-sub);
  gap: 2px; /* Tighter gap for better fit */
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}

.dock-item span {
  font-size: 18px; /* Slightly smaller icons to fit 5 items */
}

.dock-item small {
  font-size: 9px; /* Optimized label size */
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.2px;
  white-space: nowrap;
}

.dock-item.active {
  color: var(--primary);
}

.dock-item.active span {
  transform: translateY(-2px) scale(1.1);
}

/* Specific styling for the Logout button in the dock */
.dock-item[onclick="logout()"] {
  opacity: 0.8;
}

.dock-item[onclick="logout()"]:active {
  transform: scale(0.9);
  opacity: 1;
}
/* üì± PERFECT MOBILE DOCK */
/* üì± MOBILE DOCK (FINAL) */
.mobile-dock {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;

  height: 70px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);

  display: flex;
  justify-content: space-around;
  align-items: center;

  padding-bottom: env(safe-area-inset-bottom);
  border-top: 1px solid var(--surface-border);
  box-shadow: 0 -10px 30px rgba(0,0,0,0.08);
  z-index: 10000;
}

.dock-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: none;
  border: none;
  color: var(--text-sub);
  gap: 4px;
  transition: all 0.2s ease;
  cursor: pointer;
}

.dock-item span {
  font-size: 20px;
  transition: transform 0.2s ease;
}

.dock-item small {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.dock-item.active {
  color: var(--primary);
}

.dock-item.active span {
  transform: translateY(-4px) scale(1.1);
}

/* Hide dock on desktop */
@media (min-width: 769px) {
  .mobile-dock { display: none; }
}
/* ================================
   GLOBAL RESET
================================ */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}
/* üåê Language Toggle */
.lang-toggle {
  display: flex;
  gap: 6px;
  padding: 6px;
  border-radius: 18px;
  background: var(--surface);
  border: 1px solid var(--surface-border);
  box-shadow: var(--shadow);
}

.lang-toggle button {
  padding: 6px 10px;
  border-radius: 14px;
  border: none;
  cursor: pointer;
  font-weight: 800;
  font-size: 12px;
  background: transparent;
  color: var(--text-sub);
}

.lang-toggle button.active {
  background: var(--gradient-primary);
  color: white;
}
/* ===== MOBILE SIDEBAR OVERLAY ===== */
.mobile-sidebar {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 9998;
  display: none;
}

.mobile-sidebar.active {
  display: block;
}

.mobile-sidebar .sidebar {
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  width: 260px;
  animation: slideIn 0.3s ease forwards;
}

@keyframes slideIn {
  from { transform: translateX(-100%); }
  to { transform: translateX(0); }
}
body {
  font-family: 'Manrope', sans-serif;
  background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #bbf7d0 100%);
  color: var(--text-main);

  min-height: 100vh;
  min-height: 100dvh; /* ‚úÖ mobile-safe viewport */

  overflow-x: hidden;
  overflow-y: auto;  /* ‚úÖ allow scroll */

  position: relative;
}


.logo-glow {
  border-radius: 50%;
  animation: glowPulse 2.5s infinite ease-in-out;
}

@keyframes glowPulse {
  0% {
    box-shadow: 0 0 0 rgba(16,185,129,0.4);
  }
  50% {
    box-shadow: 0 0 20px rgba(16,185,129,0.8);
  }
  100% {
    box-shadow: 0 0 0 rgba(16,185,129,0.4);
  }
}
@media (max-width: 768px) {
  .dashboard-container { flex-direction: column; }
  .sidebar { display: none; }
  
  .main-content {
    padding: 16px 12px; /* Reduced for mobile */
    padding-bottom: 100px;
    width: 100%;
    overflow-x: hidden;
  }

  .bento-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .col-12, .col-8, .col-6, .col-4, .col-3 {
    grid-column: span 12 !important; /* Force full width on mobile */
  }

  .greeting-box h1 { font-size: 1.3rem; }
  .stat-val { font-size: 1.8rem; }
  
  .card {
    padding: 16px; /* Smaller padding for cards */
    margin-bottom: 5px;
  }
  
  .header-bar {
    padding: 10px 5px;
    margin-bottom: 15px;
    min-height: auto;
  }
}
/* ‚ú® ANIMATED BACKGROUND ORBS */
body::before,
body::after {
  content: '';
  position: fixed;
  border-radius: 50%;
  filter: blur(100px);
  opacity: 0.15;
  animation: float 20s ease-in-out infinite;
  pointer-events: none;
  z-index: 0;
}

body::before {
  width: 500px;
  height: 500px;
  background: var(--primary);
  top: -200px;
  left: -200px;
  animation-delay: -5s;
}

body::after {
  width: 400px;
  height: 400px;
  background: var(--accent);
  bottom: -150px;
  right: -150px;
}

@keyframes float {
  0%, 100% { transform: translate(0, 0) scale(1); }
  33% { transform: translate(50px, -50px) scale(1.1); }
  66% { transform: translate(-30px, 30px) scale(0.9); }
}

/* ================================
   LAYOUT
================================ */
.dashboard-container {
  display: flex;
  height: 100%;
  position: relative;
  z-index: 1;
}

/* ‚ú® ENHANCED SIDEBAR */
.sidebar {
  width: 280px;
  padding: 36px 24px;
  background: var(--surface);
  border-right: 1px solid var(--surface-border);
  backdrop-filter: blur(30px) saturate(180%);
  box-shadow: 4px 0 24px rgba(0,0,0,0.06);
  position: relative;
  overflow: hidden;
}

.sidebar::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: var(--gradient-primary);
}

.logo {
  font-size: 24px;
  font-weight: 800;
  margin-bottom: 40px;
  line-height: 1.2;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  display: flex;
  align-items: center;
  gap: 10px;
  animation: slideInLeft 0.6s ease;
}

@keyframes slideInLeft {
  from { opacity: 0; transform: translateX(-20px); }
  to { opacity: 1; transform: translateX(0); }
}

/* ‚ú® SIDEBAR BUTTONS */
.sidebar-btn {
  padding: 16px 20px;
  border-radius: 16px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 14px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  color: var(--text-sub);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.sidebar-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: var(--gradient-soft);
  transition: left 0.4s ease;
  z-index: -1;
}

.sidebar-btn:hover::before {
  left: 0;
}

.sidebar-btn:hover {
  transform: translateX(4px);
  color: var(--primary-dark);
}

.sidebar-btn.active {
  background: var(--gradient-primary);
  color: #fff;
  box-shadow: 0 8px 20px var(--accent-glow);
  transform: scale(1.02);
}

.sidebar-btn span {
  font-size: 20px;
  transition: transform 0.3s ease;
}

.sidebar-btn:hover span {
  transform: scale(1.15) rotate(5deg);
}

/* ================================
   MAIN CONTENT
================================ */
.main-content {
  flex: 1;
  padding: 32px 40px;
  overflow-y: auto;
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* ‚ú® ENHANCED HEADER */
.header-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;

  min-height: 110px;          /* üîë reserves space */
  padding: 24px 32px;
  margin-bottom: 32px;

  background: transparent;
}


@keyframes slideDown {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.greeting-box h1 {
  font-size: 2rem;
  font-weight: 800;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  margin-bottom: 4px;
}

.greeting-box p {
  font-size: 15px;
  color: var(--text-sub);
  font-weight: 500;
}

/* ‚ú® HEADER CONTROLS */
.controls {
  display: flex;
  gap: 14px;
}

.control-btn,
.notify-bell {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--surface);
  border: 1px solid var(--surface-border);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 20px;
  transition: all 0.3s ease;
  box-shadow: var(--shadow);
}

.control-btn:hover,
.notify-bell:hover {
  transform: translateY(-2px) scale(1.05);
  box-shadow: var(--shadow-hover);
  border-color: var(--primary);
}

.control-btn:active,
.notify-bell:active {
  transform: scale(0.95);
}

/* ================================
   GRID & CARDS - ENHANCED
================================ */
.bento-grid {
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: 20px;
  animation: fadeInUp 0.7s ease;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.col-12 { grid-column: span 12; }
.col-8  { grid-column: span 8; }
.col-6  { grid-column: span 6; }
.col-4  { grid-column: span 4; }
.col-3  { grid-column: span 3; }

/* ‚ú® PREMIUM CARD DESIGN */
.card {
  background: var(--surface);
  border: 1px solid var(--surface-border);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
  backdrop-filter: blur(20px) saturate(180%);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 3px;
  background: var(--gradient-primary);
  transform: scaleX(0);
  transition: transform 0.3s ease;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-hover);
  border-color: var(--primary);
}

.card:hover::before {
  transform: scaleX(1);
}

/* ‚ú® INSIGHT CARD */
.insight-card {
  background: var(--gradient-soft);
  border: 2px solid var(--primary-light);
  padding: 20px 24px;
}

.insight-card p {
  font-size: 15px;
  line-height: 1.7;
  color: var(--primary-dark);
  font-weight: 600;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.insight-card span {
  display: block;
}

/* ‚ú® STAT CARDS */
.stat-badge {
  display: inline-block;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  background: var(--primary-light);
  color: var(--primary-dark);
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stat-val {
  font-size: 2.5rem;
  font-weight: 800;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  margin: 8px 0;
}

.stat-label {
  font-size: 14px;
  color: var(--text-sub);
  font-weight: 600;
}

/* ===== MILK BUTTON GRID - ENHANCED ===== */
.milk-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
  margin: 20px 0;
}

.milk-btn {
  position: relative;
  padding: 20px 18px;
  border-radius: 16px;
  border: 2px solid var(--surface-border);
  background: var(--surface);
  font-weight: 800;
  font-size: 16px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.milk-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 24px rgba(16,185,129,0.2);
  border-color: var(--primary);
}

.milk-btn.active {
  border-color: var(--primary);
  background: var(--gradient-soft);
  box-shadow: 0 8px 24px var(--accent-glow);
  transform: scale(1.05);
}

.milk-btn.active::after {
  content: "‚úì";
  position: absolute;
  top: 10px;
  right: 12px;
  font-size: 14px;
  font-weight: 900;
  color: white;
  background: var(--gradient-primary);
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px var(--accent-glow);
  animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

@keyframes popIn {
  0% { transform: scale(0); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}

/* ================================
   TABLE - ENHANCED
================================ */
.table-wrapper {
  overflow-x: auto;
  border-radius: 12px;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th {
  text-align: left;
  font-size: 12px;
  font-weight: 700;
  color: var(--text-sub);
  padding: 14px 12px;
  background: var(--primary-light);
  border-bottom: 2px solid var(--primary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

td {
  padding: 14px 12px;
  font-size: 14px;
  border-bottom: 1px solid rgba(0,0,0,0.05);
  transition: background 0.2s ease;
}

tr:hover td {
  background: var(--primary-light);
}

/* ================================
   CALENDAR - ENHANCED
================================ */
.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 10px;
  margin-top: 16px;
}

.calendar-day {
  padding: 12px 6px;
  border-radius: 14px;
  font-size: 13px;
  font-weight: 700;
  background: rgba(255,255,255,0.7);
  text-align: center;
  transition: all 0.3s ease;
  cursor: pointer;
  border: 2px solid transparent;
}

.calendar-day:hover {
  transform: scale(1.05);
  border-color: var(--primary);
  box-shadow: 0 4px 12px var(--accent-glow);
}

.calendar-day.active {
  background: var(--gradient-primary);
  color: #fff;
  box-shadow: 0 6px 16px var(--accent-glow);
  transform: scale(1.08);
}

.calendar-day small {
  display: block;
  font-size: 11px;
  margin-top: 4px;
  opacity: 0.9;
}

/* ================================
   BUTTONS - ENHANCED
================================ */
.btn-main {
  padding: 16px 24px;
  border-radius: 16px;
  background: var(--gradient-primary);
  border: none;
  color: #fff;
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 6px 20px var(--accent-glow);
  position: relative;
  overflow: hidden;
}

.btn-main::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255,255,255,0.3);
  transform: translate(-50%, -50%);
  transition: width 0.5s, height 0.5s;
}

.btn-main:hover::before {
  width: 300px;
  height: 300px;
}

.btn-main:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 30px var(--accent-glow);
}

.btn-main:active {
  transform: scale(0.98);
}

.btn-sec {
  padding: 12px 20px;
  border-radius: 14px;
  background: transparent;
  border: 2px solid var(--primary);
  color: var(--primary);
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-sec:hover {
  background: var(--primary);
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px var(--accent-glow);
}

/* ===== SEARCH BAR - ENHANCED ===== */
.search-wrap {
  position: relative;
  width: 100%;
  margin-bottom: 28px;
  animation: slideInRight 0.6s ease;
}

@keyframes slideInRight {
  from { opacity: 0; transform: translateX(20px); }
  to { opacity: 1; transform: translateX(0); }
}

.search-wrap span {
  position: absolute;
  left: 20px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 20px;
  color: var(--text-sub);
  pointer-events: none;
  transition: all 0.3s ease;
}

.search-input {
  width: 100%;
  padding: 18px 24px 18px 54px;
  border-radius: 20px;
  border: 2px solid var(--surface-border);
  background: var(--surface);
  backdrop-filter: blur(20px);
  font-size: 16px;
  font-weight: 600;
  color: var(--text-main);
  transition: all 0.3s ease;
  box-shadow: var(--shadow);
}

.search-input::placeholder {
  color: var(--text-sub);
  font-weight: 500;
}

.search-input:focus {
  outline: none;
  background: #ffffff;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px var(--accent-glow), var(--shadow-hover);
  transform: translateY(-2px);
}

.search-input:focus + span {
  color: var(--primary);
  transform: translateY(-50%) scale(1.1);
}

/* ===== AUTH SCREEN - ENHANCED ===== */
.auth-wrap {
  width: 100%;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #bbf7d0 0%, #d1fae5 50%, #ecfdf5 100%);
  position: relative;
  overflow: hidden;
}

.auth-wrap::before,
.auth-wrap::after {
  content: '';
  position: absolute;
  border-radius: 50%;
  filter: blur(120px);
  opacity: 0.2;
  animation: float 15s ease-in-out infinite;
}

.auth-wrap::before {
  width: 600px;
  height: 600px;
  background: var(--primary);
  top: -250px;
  right: -200px;
}

.auth-wrap::after {
  width: 500px;
  height: 500px;
  background: var(--accent);
  bottom: -200px;
  left: -150px;
  animation-delay: -7s;
}

.auth-glass {
  width: 100%;
  max-width: 440px;
  background: rgba(255,255,255,0.95);
  border-radius: 32px;
  padding: 48px 40px;
  box-shadow: 0 40px 80px rgba(0,0,0,0.15);
  text-align: center;
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.5);
  animation: scaleIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  position: relative;
  z-index: 1;
}

@keyframes scaleIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}

.auth-logo {
  font-size: 56px;
  margin-bottom: 12px;
  animation: bounce 2s ease-in-out infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.auth-title {
  font-size: 32px;
  font-weight: 800;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  margin-bottom: 8px;
  text-transform: lowercase;
}

.auth-sub {
  font-size: 15px;
  color: var(--text-sub);
  margin-bottom: 32px;
  font-weight: 500;
}

.auth-input {
  width: 100%;
  padding: 18px 22px;
  border-radius: 16px;
  border: 2px solid rgba(16,185,129,0.2);
  background: #f9fafb;
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 18px;
  outline: none;
  transition: all 0.3s ease;
}

.auth-input:focus {
  box-shadow: 0 0 0 4px var(--accent-glow);
  background: #ffffff;
  border-color: var(--primary);
  transform: translateY(-2px);
}

.auth-pass {
  position: relative;
}

.auth-pass span {
  position: absolute;
  right: 18px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  font-size: 20px;
  transition: transform 0.2s ease;
}

.auth-pass span:hover {
  transform: translateY(-50%) scale(1.2);
}

.auth-btn {
  width: 100%;
  padding: 18px;
  border-radius: 18px;
  border: none;
  background: var(--gradient-primary);
  color: #ffffff;
  font-size: 17px;
  font-weight: 800;
  cursor: pointer;
  margin-top: 12px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 24px var(--accent-glow);
}

.auth-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 32px var(--accent-glow);
}

.auth-btn:active {
  transform: scale(0.98);
}

.auth-link {
  margin-top: 24px;
  color: var(--primary);
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-block;
}

.auth-link:hover {
  color: var(--primary-dark);
  transform: scale(1.05);
}

/* ‚ú® FARMER CARDS - ENHANCED */
.farmer-card {
  cursor: pointer;
  text-align: center;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.farmer-card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 16px 40px rgba(16,185,129,0.25);
}

.farmer-card h3 {
  font-size: 18px;
  font-weight: 800;
  color: var(--text-main);
}

/* ‚ú® MONTH BOX - ENHANCED */
.month-box {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
}

.month-box:hover {
  transform: translateY(-6px) scale(1.03);
  box-shadow: 0 12px 32px var(--accent-glow);
  border-color: var(--primary);
}

/* ================================
   MOBILE (RESPONSIVE)
================================ */


@media (min-width: 769px) {
  .mobile-nav,
  .mobile-dock,
  .top-nav,
  .breadcrumb-nav {
    display: none !important;
  }
}

/* ‚ú® TOAST NOTIFICATION - ENHANCED */
#toast {
  visibility: hidden;
  min-width: 250px;
  background: rgba(17, 24, 39, 0.95);
  backdrop-filter: blur(20px);
  color: white;
  text-align: center;
  border-radius: 50px;
  padding: 14px 28px;
  position: fixed;
  z-index: 9999;
  left: 50%;
  top: 24px;
  transform: translateX(-50%);
  font-weight: 600;
  font-size: 15px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.3);
  animation: slideInDown 0.5s ease;
}

@keyframes slideInDown {
  from { opacity: 0; transform: translate(-50%, -20px); }
  to { opacity: 1; transform: translate(-50%, 0); }
}

/* ‚ú® EMPTY STATE */
.empty-state {
  text-align: center;
  padding: 60px 20px;
}

.empty-state .icon {
  font-size: 64px;
  margin-bottom: 16px;
  animation: bounce 2s ease-in-out infinite;
}

.empty-state h3 {
  font-size: 22px;
  font-weight: 800;
  margin-bottom: 8px;
  color: var(--text-main);
}

.empty-state p {
  color: var(--text-sub);
  margin-bottom: 24px;
  font-size: 15px;
}

/* ‚ú® LOADING SKELETON */
.skeleton {
  background: linear-gradient(
    90deg,
    rgba(16,185,129,0.05) 25%,
    rgba(16,185,129,0.1) 50%,
    rgba(16,185,129,0.05) 75%
  );
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  min-height: 120px;
}

@keyframes shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* ‚ú® SCROLLBAR */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: transparent;
}
.mobile-dock.hidden {
  transform: translateY(100%);
  transition: transform 0.3s ease;
}

::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--primary-dark);
}
  </style>
</head>
<body>

<div id="app" style="width:100%; height:100%"></div>
<div id="toast" style="visibility:hidden;"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script><script>
let adminUsersInterval = null;
  let isEditingUser = false;
function logAudit(action, meta={}) {
  const logs = JSON.parse(localStorage.getItem('auditLogs')) || [];
  logs.unshift({
    time: new Date().toISOString(),
    admin: JSON.parse(localStorage.getItem('user'))?.username,
    action,
    meta
  });
  localStorage.setItem('auditLogs', JSON.stringify(logs.slice(0,300)));
}

  window.onerror = function (msg, src, line, col) {
  console.error("JS Error:", msg, "at", line);
};


  const SESSION_TIMEOUT = 120 * 60 * 1000;
let sessionTimer = null;
let lastSyncTime = null;

const APP_LOGO_URL = "./logo.png";

const PRICES = { twoL: 140, oneL: 70, threeQuarterL: 55, halfL: 35 };
let currentLang = localStorage.getItem('lang') || 'en';
let currentTheme = localStorage.getItem('theme') || 'light';
let selectedMilk = { twoL: 0, oneL: 0, threeQuarterL: 0, halfL: 0 };
let currentMonthView = null;
if(currentTheme === 'dark') document.body.classList.add('dark-mode');

const T = {
  en: {
    // General
    welcome: "Welcome",
    goodMorning: "Good Morning",
    goodEvening: "Good Evening",
    admin: "Admin",
    user: "User",

    // Sidebar
    overview: "Overview",
    orders: "Orders",
    farmers: "Farmers",
    progress: "Progress",
    profile: "Profile",
    logout: "Logout",

    // Dashboard
    totalBill: "Total Bill",
    activeDays: "Active Days",
    needMilk: "Need Milk?",
    requestMilk: "Request Milk",
    monthlySpend: "Monthly Spend",
    consumption: "Consumption",

    // Progress
    selectMonth: "Select Month",
    milkDetails: "Milk Entry Details",
    milkCalendar: "Milk Calendar",
    back: "Back",
    total: "Total",

    // Orders
    history: "History",
    noOrders: "No orders yet",
    orderMilk: "Order Milk",
    submit: "Submit Order",

    // Admin
    totalRevenue: "Total Revenue",
    packets: "Packets",
    manage: "Tap to manage",
    addEntry: "Add Entry",
    save: "Save",
    delete: "Delete",

    // Profile
    customerSince: "Customer since",
    totalSpend: "Total Spend",
    preferredSize: "Preferred Size",
    changePassword: "Change Password",
    security: "Security",

    // Status
    active: "Active",
    idle: "Idle",
    inactive: "Inactive",
    offline: "Offline"
  },

  te: {
    // General
    welcome: "‡∞∏‡±ç‡∞µ‡∞æ‡∞ó‡∞§‡∞Ç",
    goodMorning: "‡∞∂‡±Å‡∞≠‡±ã‡∞¶‡∞Ø‡∞Ç",
    goodEvening: "‡∞∂‡±Å‡∞≠ ‡∞∏‡∞æ‡∞Ø‡∞Ç‡∞§‡±ç‡∞∞‡∞Ç",
    admin: "‡∞®‡∞ø‡∞∞‡±ç‡∞µ‡∞æ‡∞π‡∞ï‡±Å‡∞°‡±Å",
    user: "‡∞µ‡∞ø‡∞®‡∞ø‡∞Ø‡±ã‡∞ó‡∞¶‡∞æ‡∞∞‡±Å",

    // Sidebar
    overview: "‡∞Ö‡∞µ‡∞≤‡±ã‡∞ï‡∞®‡∞Ç",
    orders: "‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç‡∞≤‡±Å",
    farmers: "‡∞∞‡±à‡∞§‡±Å‡∞≤‡±Å",
    progress: "‡∞™‡±Å‡∞∞‡±ã‡∞ó‡∞§‡∞ø",
    profile: "‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç",
    logout: "‡∞≤‡∞æ‡∞ó‡±ç ‡∞Ö‡∞µ‡±Å‡∞ü‡±ç",

    // Dashboard
    totalBill: "‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞¨‡∞ø‡∞≤‡±ç‡∞≤‡±Å",
    activeDays: "‡∞ï‡±ç‡∞∞‡∞ø‡∞Ø‡∞æ‡∞∂‡±Ä‡∞≤ ‡∞∞‡±ã‡∞ú‡±Å‡∞≤‡±Å",
    needMilk: "‡∞™‡∞æ‡∞≤‡±Å ‡∞ï‡∞æ‡∞µ‡∞æ‡∞≤‡∞æ?",
    requestMilk: "‡∞™‡∞æ‡∞≤‡±Å ‡∞ï‡±ã‡∞∞‡∞Ç‡∞°‡∞ø",
    monthlySpend: "‡∞®‡±Ü‡∞≤‡∞µ‡∞æ‡∞∞‡±Ä ‡∞ñ‡∞∞‡±ç‡∞ö‡±Å",
    consumption: "‡∞µ‡∞ø‡∞®‡∞ø‡∞Ø‡±ã‡∞ó‡∞Ç",

    // Progress
    selectMonth: "‡∞®‡±Ü‡∞≤‡∞®‡±Å ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø",
    milkDetails: "‡∞™‡∞æ‡∞≤ ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å",
    milkCalendar: "‡∞™‡∞æ‡∞≤ ‡∞ï‡±ç‡∞Ø‡∞æ‡∞≤‡±Ü‡∞Ç‡∞°‡∞∞‡±ç",
    back: "‡∞µ‡±Ü‡∞®‡∞ï‡±ç‡∞ï‡∞ø",
    total: "‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç",

    // Orders
    history: "‡∞ö‡∞∞‡∞ø‡∞§‡±ç‡∞∞",
    noOrders: "‡∞á‡∞Ç‡∞ï‡∞æ ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç‡∞≤‡±Å ‡∞≤‡±á‡∞µ‡±Å",
    orderMilk: "‡∞™‡∞æ‡∞≤‡±Å ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø",
    submit: "‡∞∏‡∞Æ‡∞∞‡±ç‡∞™‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø",

    // Admin
    totalRevenue: "‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞Ü‡∞¶‡∞æ‡∞Ø‡∞Ç",
    packets: "‡∞™‡±ç‡∞Ø‡∞æ‡∞ï‡±Ü‡∞ü‡±ç‡∞≤‡±Å",
    manage: "‡∞®‡∞ø‡∞∞‡±ç‡∞µ‡∞π‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø",
    addEntry: "‡∞é‡∞Ç‡∞ü‡±ç‡∞∞‡±Ä ‡∞ú‡±ã‡∞°‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø",
    save: "‡∞∏‡±á‡∞µ‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø",
    delete: "‡∞§‡±ä‡∞≤‡∞ó‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø",

    // Profile
    customerSince: "‡∞µ‡∞ø‡∞®‡∞ø‡∞Ø‡±ã‡∞ó‡∞¶‡∞æ‡∞∞‡±Å‡∞ó‡∞æ",
    totalSpend: "‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞ñ‡∞∞‡±ç‡∞ö‡±Å",
    preferredSize: "‡∞á‡∞∑‡±ç‡∞ü‡∞Æ‡±à‡∞® ‡∞™‡∞∞‡∞ø‡∞Æ‡∞æ‡∞£‡∞Ç",
    changePassword: "‡∞™‡∞æ‡∞∏‡±ç‚Äå‡∞µ‡∞∞‡±ç‡∞°‡±ç ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ö‡∞Ç‡∞°‡∞ø",
    security: "‡∞≠‡∞¶‡±ç‡∞∞‡∞§",

    // Status
    active: "‡∞ï‡±ç‡∞∞‡∞ø‡∞Ø‡∞æ‡∞∂‡±Ä‡∞≤‡∞Ç",
    idle: "‡∞®‡∞ø‡∞∑‡±ç‡∞ï‡±ç‡∞∞‡∞ø‡∞Ø",
    inactive: "‡∞Ö‡∞ö‡±á‡∞§‡∞®‡∞Ç",
    offline: "‡∞Ü‡∞´‡±ç‚Äå‡∞≤‡±à‡∞®‡±ç"
  }
};

function setLang(lang) {
  currentLang = lang;
  localStorage.setItem('lang', lang);

  document.getElementById('langEn')?.classList.toggle('active', lang === 'en');
  document.getElementById('langTe')?.classList.toggle('active', lang === 'te');

  const saved = JSON.parse(localStorage.getItem('user'));
  if (!saved) {
    renderAuth();
    return;
  }

  // Re-render current view safely
  const lastTab = getLastTab();
  if (saved.role === 'admin') {
    if (lastTab === 'users') adminUsers();
    else if (lastTab === 'orders') adminOrders();
    else adminSummary();
  } else {
    if (lastTab === 'progress') userProgress();
    else if (lastTab === 'orders') userOrders();
    else if (lastTab === 'profile') userProfile();
    else userHome();
  }
}


function toggleTheme() {
  currentTheme = currentTheme === 'light' ? 'dark' : 'light';
  localStorage.setItem('theme', currentTheme);
  document.body.classList.toggle('dark-mode');
}

const t = (k) => T[currentLang][k] || k;
const app = document.getElementById("app");

function generateInsights(sales) {
  if (!sales || sales.length < 2) {
    return "üìä Start ordering to see smart insights about your milk usage.";
  }

  let total = 0;
  let monthTotals = {};
  let milkCount = { twoL:0, oneL:0, threeQuarterL:0, halfL:0 };

  sales.forEach(s => {
    const bill =
      (s.twoL*140) +
      (s.oneL*70) +
      (s.threeQuarterL*55) +
      (s.halfL*35);

    total += bill;

    const m = s.date.split('/')[1];
    monthTotals[m] = (monthTotals[m] || 0) + bill;

    milkCount.twoL += s.twoL || 0;
    milkCount.oneL += s.oneL || 0;
    milkCount.threeQuarterL += s.threeQuarterL || 0;
    milkCount.halfL += s.halfL || 0;
  });

  const favoriteMilk = Object.entries(milkCount)
    .sort((a,b) => b[1]-a[1])[0][0];

  const milkMap = {
    twoL: '2L',
    oneL: '1L',
    threeQuarterL: '3/4L',
    halfL: '1/2L'
  };

  const months = Object.keys(monthTotals);
  let trendMsg = "üìâ Your spending is stable.";

  if (months.length >= 2) {
    const last = monthTotals[months[months.length-1]];
    const prev = monthTotals[months[months.length-2]];
    const diff = ((last - prev) / prev * 100).toFixed(1);

    if (diff > 0) trendMsg = `üìà Your milk spending increased by ${diff}% this month.`;
    else trendMsg = `üìâ Your milk spending decreased by ${Math.abs(diff)}% this month.`;
  }

  return `
    ${trendMsg}
    <span>ü•õ Most preferred size: ${milkMap[favoriteMilk]}</span>
  `;
}
function getMonthTotal(sales = []) {
  return sales.reduce((sum, s) => {
    return sum +
      (s.twoL * 140) +
      (s.oneL * 70) +
      (s.threeQuarterL * 55) +
      (s.halfL * 35);
  }, 0);
}
function toggleMobileSidebar() {
  const sidebar = document.getElementById('mobileSidebar');
  if (!sidebar) return;

  sidebar.classList.toggle('active');
}


function getGreeting() {
  const h = new Date().getHours();
  if (currentLang === 'te') {
    return h < 12 ? "‡∞∂‡±Å‡∞≠‡±ã‡∞¶‡∞Ø‡∞Ç ‚òÄÔ∏è" : "‡∞∂‡±Å‡∞≠ ‡∞∏‡∞æ‡∞Ø‡∞Ç‡∞§‡±ç‡∞∞‡∞Ç  üå§Ô∏è";
  }
  return h < 12 ? "Good Morning ‚òÄÔ∏è" : "Good Evening  üå§Ô∏è";
}
function toggleTheme() {
  currentTheme = currentTheme === 'light' ? 'dark' : 'light';
  localStorage.setItem('theme', currentTheme);
  document.body.classList.toggle('dark-mode');

  const icon = document.getElementById('themeIcon');
  if (icon) {
    icon.innerText = currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
  }
}

function showToast(m) { const x=document.getElementById("toast"); x.style.visibility="visible"; x.innerText=m; setTimeout(()=>x.style.visibility="hidden",3000); }
function fireConfetti() { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#10b981', '#34d399', '#ffffff'] }); }
function getMonthName(m) { return ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][parseInt(m)-1]; }
function sortSalesByDate(sales) { return sales.sort((a, b) => { const [d1, m1, y1] = a.date.split('/'); const [d2, m2, y2] = b.date.split('/'); return new Date(y1, m1-1, d1) - new Date(y2, m2-1, d2); }); }
function calculateStats(sales) { let s={t2:0, t1:0, t34:0, t12:0, days:sales.length, total:0}; sales.forEach(x => { s.t2+=x.twoL||0; s.t1+=x.oneL||0; s.t34+=x.threeQuarterL||0; s.t12+=x.halfL||0; s.total += (x.twoL*PRICES.twoL)+(x.oneL*PRICES.oneL)+(x.threeQuarterL*PRICES.threeQuarterL)+(x.halfL*PRICES.halfL); }); return s; }

function renderMilkCalendar(sales, month, year) {
  const daysInMonth = new Date(year, month, 0).getDate();
  let html = `<div class="calendar-grid">`;

  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${String(day).padStart(2,'0')}/${String(month).padStart(2,'0')}/${year}`;
    const sale = sales.find(s => s.date === dateStr);

    let content = day;
    if (sale) {
      const cost =
        (sale.twoL*140) +
        (sale.oneL*70) +
        (sale.threeQuarterL*55) +
        (sale.halfL*35);

      content += `<small>‚Çπ${cost}</small>`;
    }

    html += `
      <div class="calendar-day ${sale ? 'active' : ''}"
           onclick="showDayDetails('${dateStr}')">
        ${content}
      </div>
    `;
  }

  html += `</div>`;
  return html;
}
function resetSessionTimer() {
  clearTimeout(sessionTimer);
  sessionTimer = setTimeout(() => {
    showToast("üîí Session expired. Logged out.");
    logout();
  }, SESSION_TIMEOUT);
}
['click','mousemove','keydown','touchstart','scroll'].forEach(evt => {
  window.addEventListener(evt, resetSessionTimer, { passive: true });
});

function showDayDetails(date) {
  const u = JSON.parse(localStorage.getItem('user'));
  fetch(`/user/${u.username}`)
    .then(r => r.json())
    .then(data => {
      const sale = data.sales.find(s => s.date === date);
      if (!sale) {
        showToast(`No milk entry on ${date}`);
        return;
      }

      const details = `
        üóìÔ∏è ${date}
        ü•õ ${sale.twoL?'2L ':''}${sale.oneL?'1L ':''}${sale.threeQuarterL?'3/4L ':''}${sale.halfL?'1/2L':''}
      `;
      showToast(details);
    });
}
function updateLastSync() {
  lastSyncTime = new Date();
}

function saveLastTab(tab) {
  localStorage.setItem('lastTab', tab);
}


function getLastTab() {
  return localStorage.getItem('lastTab');
}

function showNetStatus(type, text) {
  const bar = document.getElementById('netStatus');
  bar.className = type === 'online' ? 'net-online' : 'net-offline';
  bar.innerText = text;
  bar.style.display = 'block';

  if (type === 'online') {
    setTimeout(() => bar.style.display = 'none', 3000);
  }
}

window.addEventListener('offline', () => {
  showNetStatus('offline', 'üì¥ You are offline');
});

window.addEventListener('online', () => {
  showNetStatus('online', '‚úÖ Back online');
});
function requireOnline(action) {
  if (!navigator.onLine) {
    showNetStatus('offline', 'üì¥ No internet connection');
    return false;
  }
  action();
}

let notifications = [];

function addNotification(text) {
  notifications.unshift({
    id: Date.now(),
    text
  });
}

function emptyState({ icon, title, message, actionText, action }) {
  return `
    <div class="card col-12">
      <div class="empty-state">
        <div class="icon">${icon}</div>
        <h3>${title}</h3>
        <p>${message}</p>
        ${
          actionText
            ? `<button class="btn-main" onclick="${action}">${actionText}</button>`
            : ``
        }
      </div>
    </div>
  `;
}

function toggleNotifications() {
  const panel = document.getElementById('notifyPanel');
  panel.classList.toggle('active');

  panel.innerHTML = notifications.length
    ? notifications.map(n => `<div style="padding:8px 0;border-bottom:1px solid #eee">${n.text}</div>`).join('')
    : `<div style="text-align:center;color:var(--text-sub)">No notifications</div>`;
}


function showDashboardSkeleton() {
  app.innerHTML = `
    <div class="dashboard-container">
      <div class="sidebar"></div>
      <div class="main-content">
        <div class="bento-grid">
          <div class="card skeleton"></div>
          <div class="card skeleton"></div>
          <div class="card skeleton"></div>
          <div class="card skeleton col-8"></div>
          <div class="card skeleton col-4"></div>
        </div>
      </div>
    </div>
  `;
}

let lastScrollY = window.scrollY;

window.addEventListener('scroll', () => {
  const dock = document.querySelector('.mobile-dock');
  if (!dock) return;

  if (window.scrollY > lastScrollY && window.scrollY > 80) {
    dock.classList.add('hidden');
  } else {
    dock.classList.remove('hidden');
  }
  lastScrollY = window.scrollY;
});

function makeAccessible(el, action, label) {
  el.setAttribute('role', 'button');
  el.setAttribute('tabindex', '0');
  if (label) el.setAttribute('aria-label', label);

  el.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      action();
    }
  });
}
function adminDock(tab) {
  return `
    <div class="mobile-dock display-none-desktop">
      <button class="dock-item ${tab==='summary'?'active':''}" onclick="adminSummary()"><span>üìä</span><small>Summary</small></button>
      <button class="dock-item ${tab==='orders'?'active':''}" onclick="adminOrders()"><span>üì¶</span><small>Orders</small></button>
      <button class="dock-item ${tab==='users'?'active':''}" onclick="adminUsers()"><span>üë®‚Äçüåæ</span><small>Farmers</small></button>
      <button class="dock-item" onclick="logout()" style="color:#ef4444"><span>üõë</span><small>${t('logout')}</small></button>
    </div>
  `;
}

function userDock(tab) {
  return `
    <div class="mobile-dock display-none-desktop">
      <button class="dock-item ${tab==='home'?'active':''}" onclick="userHome()"><span>üè†</span><small>Home</small></button>
      <button class="dock-item ${tab==='progress'?'active':''}" onclick="userProgress()"><span>üìà</span><small>Progress</small></button>
      <button class="dock-item ${tab==='orders'?'active':''}" onclick="userOrders()"><span>üõí</span><small>Orders</small></button>
      <button class="dock-item ${tab==='profile'?'active':''}" onclick="userProfile()"><span>üë§</span><small>Profile</small></button>
      <button class="dock-item" onclick="logout()" style="color:#ef4444"><span>üõë</span><small>${t('logout')}</small></button>
    </div>
  `;
}

function adminAudit() {
  saveLastTab('audit');

  const u = JSON.parse(localStorage.getItem('user'));
  const logs = JSON.parse(localStorage.getItem('auditLogs')) || [];

  renderShell(u, `
    <div class="card col-12">
      <h3>Admin Audit Log</h3>

      <div class="table-wrapper" style="max-height:500px;overflow:auto">
        <table>
          <tr>
            <th>Time</th>
            <th>Admin_toggle</th>
            <th>Action</th>
            <th>Details</th>
          </tr>

          ${logs.length ? logs.map(l => `
            <tr>
              <td>${new Date(l.time).toLocaleString()}</td>
              <td>${l.admin}</td>
              <td>${l.action}</td>
              <td>${JSON.stringify(l.meta)}</td>
            </tr>
          `).join('') : `
            <tr>
              <td colspan="4" style="text-align:center">
                No audit logs yet
              </td>
            </tr>
          `}
        </table>
      </div>
    </div>
  `, 'audit');
}

function renderShell(user, content, tab) {
  const role = user.role;

  const menu = role === 'admin'
    ? [
        {k:'summary', i:'üìä', l:t('overview'), f:'adminSummary()'},
        {k:'orders', i:'üì¶', l:t('orders'), f:'adminOrders()'},
        {k:'users', i:'üë•', l:t('farmers'), f:'adminUsers()'},
        {k:'audit', i:'üßæ', l:'Audit Log', f:'adminAudit()'}
      ]
    : [
        {k:'home', i:'üè†', l:t('overview'), f:'userHome()'},
        {k:'progress', i:'üìà', l:t('progress'), f:'userProgress()'},
        {k:'orders', i:'üõí', l:t('orders'), f:'userOrders()'},
        {k:'profile', i:'üë§', l:t('profile'), f:'userProfile()'}
      ];

  const sidebarHTML = menu.map(m => `
    <div class="sidebar-btn ${tab===m.k?'active':''}" onclick="${m.f}">
      <span>${m.i}</span>${m.l}
    </div>
  `).join('');

  app.innerHTML = `
    <div class="dashboard-container">

      <!-- DESKTOP SIDEBAR -->
      <aside class="sidebar">
        <div class="logo">
          <img src="${APP_LOGO_URL}" class="logo-glow"
               style="width:60px;height:60px;border-radius:50%" />
          <span>üåæ</span>
          <span>‡∞∞‡±à‡∞§‡±Å ‡∞™‡∞æ‡∞≤‡±Å</span>
        </div>

        ${sidebarHTML}

        <div class="sidebar-btn"
             style="margin-top:auto;color:#ef4444"
             onclick="logout()">
          üõë ${t('logout')}
        </div>
      </aside>

      <!-- MAIN -->
      <main class="main-content">
        <div class="header-bar">

          <!-- LEFT (Hamburger Button Removed) -->
          <div style="display:flex;align-items:center;gap:12px">
            <div class="greeting-box">
              <h1>${getGreeting()}</h1>
              <p>${user.username}</p>
            </div>
          </div>

          <!-- RIGHT -->
          <div style="display:flex;align-items:center;gap:14px">

            <div class="lang-toggle">
              <button onclick="setLang('en')" class="${currentLang==='en'?'active':''}">EN</button>
              <button onclick="setLang('te')" class="${currentLang==='te'?'active':''}">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</button>
            </div>

            <div style="position:relative">
              <div class="notify-bell" onclick="toggleNotifications()">üîî</div>
              <div id="notifyPanel" class="notify-panel"></div>
            </div>

            <button class="control-btn" id="themeIcon" onclick="toggleTheme()">
              ${currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô'}
            </button>

          </div>
        </div>

        ${content}
      </main>

      ${role === 'admin' ? adminDock(tab) : userDock(tab)}
    </div>
  `;
  // üî• Mobile repaint fix
if (window.innerWidth <= 768) {
  requestAnimationFrame(() => {
    document.body.style.transform = 'translateZ(0)';
    setTimeout(() => {
      document.body.style.transform = '';
    }, 50);
  });
}

}
window.addEventListener('online', () => {
  document.getElementById('logoStatus')?.classList
    .replace('logo-offline', 'logo-online');
});

window.addEventListener('offline', () => {
  document.getElementById('logoStatus')?.classList
    .replace('logo-online', 'logo-offline');
});
function showLogoLoader() {
  app.innerHTML = `
    <div style="
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      gap: 20px;
    ">
      <div style="
        width: 150px;
        height: 150px;
        border-radius: 50%;
        border: 4px solid white;
        box-shadow: 0 10px 25px rgba(16,185,129,0.3);
        overflow: hidden;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: pulse 2s infinite ease-in-out;
      ">
        <img src="${APP_LOGO_URL}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2304/2304888.png'"/>
      </div>
      <div style="text-align: center;">
        <h2 style="color: var(--primary); font-weight: 800; margin-bottom: 5px;">‡∞∞‡±à‡∞§‡±Å ‡∞™‡∞æ‡∞≤‡±Å</h2>
        <div style="color: var(--text-sub); font-weight: 600; display:flex; align-items:center; gap:8px;">
          <span class="spinner"></span> Loading...
        </div>
      </div>
    </div>
    <style>
      @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
      .spinner { width: 18px; height: 18px; border: 3px solid #10b98133; border-top: 3px solid #10b981; border-radius: 50%; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
  `;
}
let charts = {}; // Global variable at the top of your script

async function userHome() {
  saveLastTab('home');
  const u = JSON.parse(localStorage.getItem('user')); 
  showDashboardSkeleton();
  const res = await fetch(`/user/${u.username}`); 
  const data = await res.json();
  updateLastSync();
  
  const st = calculateStats(data.sales);
  let mData={}; 
  data.sales.forEach(s => { 
    let m=s.date.split('/')[1]; 
    mData[m]=(mData[m]||0)+(s.twoL*140)+(s.oneL*70)+(s.threeQuarterL*55)+(s.halfL*35); 
  });
  
  const insightText = generateInsights(data.sales);

  renderShell(u, `
    <div class="bento-grid">
      <div class="card col-12 insight-card"><p>${insightText}</p></div>
      <div class="card col-4"><div class="stat-badge">Overview</div><div class="stat-val">‚Çπ${st.total.toLocaleString()}</div><div class="stat-label">${t('totalBill')}</div></div>
      <div class="card col-4"><div class="stat-badge">Activity</div><div class="stat-val">${st.days}</div><div class="stat-label">${t('activeDays')}</div></div>
      <div class="card col-4" style="background:var(--gradient-primary); color:white; cursor:pointer" onclick="userOrders()">
         <div style="font-size:2rem; margin-bottom:5px">ü•õ</div><div style="font-weight:700;">Need Milk?</div><button class="btn-main" style="background:white; color:var(--primary); padding:8px 15px; margin-top:5px; box-shadow:none">${t('requestMilk')}</button>
      </div>
      <div class="card col-8"><h3>Monthly Spend</h3><div style="height:250px"><canvas id="mainChart"></canvas></div></div>
      <div class="card col-4"><h3>Consumption</h3><div style="height:200px; display:flex; justify-content:center"><canvas id="pieChart"></canvas></div></div>
    </div>
  `, 'home');

  // Destroy old charts if they exist
  if (charts.main) charts.main.destroy();
  if (charts.pie) charts.pie.destroy();

  charts.main = new Chart(document.getElementById('mainChart'), {type:'line', data:{labels:Object.keys(mData).map(m=>getMonthName(m)), datasets:[{label:'Spend', data:Object.values(mData), borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.1)', fill:true, tension:0.4}]}, options:{responsive:true, maintainAspectRatio:false}});
  charts.pie = new Chart(document.getElementById('pieChart'), {type:'doughnut', data:{labels:['2L','1L','3/4L','1/2L'], datasets:[{data:[st.t2, st.t1, st.t34, st.t12], backgroundColor:['#064e3b','#065f46','#10b981','#6ee7b7'], borderWidth:0}]}, options:{responsive:true, maintainAspectRatio:false}});
}
function openMonth(key) {
  currentMonthView = key;
  userProgress();
}

function renderMonthView(sales, month, year) {
  const sorted = sortSalesByDate(sales);
  const stats = calculateStats(sorted);

  return `
    <div class="bento-grid">

     <div class="card col-12"
  style="
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  ">

  <!-- LEFT -->
  <button class="btn-sec"
    onclick="currentMonthView=null;userProgress()">
    ‚¨Ö Back
  </button>

  <!-- CENTER -->
  <h3 style="margin:0;font-weight:800">
    ${getMonthName(month)} ${year}
  </h3>

  <!-- RIGHT -->
  <div style="display:flex;align-items:center;gap:12px">

    <div style="
      font-weight:800;
      font-size:16px;
      color:var(--primary);
    ">
      ‚Çπ ${calculateStats(sales).total.toLocaleString()}
    </div>

    <button class="btn-main"
      onclick="downloadMonthPDF(JSON.parse(localStorage.getItem('user')).username, ${month}, ${year})">
       Download PDF
    </button>

  </div>

</div>
      <div class="card col-12">
        <h3>Milk Entry Details</h3>
        <div class="table-wrapper">
          <table>
            <tr>
              <th>Date</th>
              <th>Quantity</th>
              <th>Cost</th>
            </tr>
            ${sorted.map(s => {
              const qty =
                `${s.twoL?'2L ':''}${s.oneL?'1L ':''}${s.threeQuarterL?'3/4L ':''}${s.halfL?'1/2L':''}`;
              const cost =
                (s.twoL*140)+(s.oneL*70)+(s.threeQuarterL*55)+(s.halfL*35);

              return `
                <tr>
                  <td>${s.date}</td>
                  <td>${qty}</td>
                  <td>‚Çπ${cost}</td>
                </tr>
              `;
            }).join('')}
          </table>
        </div>
      </div>

      <div class="card col-12">
        <h3>Milk Calendar</h3>
        ${renderMilkCalendar(sorted, month, year)}
      </div>

    </div>
  `;
}

function renderMonthSelector(grouped) {
  return `
    <div class="bento-grid">
      <div class="card col-12">
        <h3>Select Month</h3>
        <p style="color:var(--text-sub)">Choose a month to view milk details</p>
      </div>

      ${Object.keys(grouped).reverse().map(k => {
  const [m, y] = k.split('-');
  const total = getMonthTotal(grouped[k]);

  return `
    <div class="card col-3 month-box"
         onclick="openMonth('${k}')"
         style="cursor:pointer; text-align:center">

      <div style="font-size:28px; margin-bottom:6px">üìÖ</div>

      <div style="font-weight:800; font-size:15px">
        ${getMonthName(m)} ${y}
      </div>

      <div style="
        margin-top:6px;
        font-size:14px;
        font-weight:700;
        color: var(--primary);
      ">
        ‚Çπ ${total.toLocaleString()}
      </div>

    </div>
  `;
}).join('')}

    </div>
  `;
}

async function userProgress() {
  saveLastTab('progress');

  const u = JSON.parse(localStorage.getItem('user'));
  const res = await fetch(`/user/${u.username}`);
const data = await res.json();

if (!data || !Array.isArray(data.sales)) {
  showToast("No milk data available");
  return;
}


  const grouped = {};
  data.sales.forEach(s => {
    const [, m, y] = s.date.split('/');
    const key = `${m}-${y}`;
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(s);
  });

  if (currentMonthView) {
    const [m, y] = currentMonthView.split('-');
    renderShell(
      u,
      renderMonthView(grouped[currentMonthView], m, y),
      'progress'
    );
    return;
  }

  renderShell(
    u,
    renderMonthSelector(grouped),
    'progress'
  );
}


async function adminSummary() {
  saveLastTab('summary');
showLogoLoader();

  const u = JSON.parse(localStorage.getItem('user'));
  const res = await fetch('/users');
  const users = await res.json();
  updateLastSync();

  let rev = 0;
  let sold = { t2:0, t1:0, t34:0, t12:0 };

  const months = {};

  users.forEach(user => user.sales.forEach(s => {
    const total =
      (s.twoL*140)+(s.oneL*70)+(s.threeQuarterL*55)+(s.halfL*35);

    rev += total;

    sold.t2 += s.twoL || 0;
    sold.t1 += s.oneL || 0;
    sold.t34 += s.threeQuarterL || 0;
    sold.t12 += s.halfL || 0;

    const [,m,y] = s.date.split('/');
    const key = `${m}-${y}`;
    months[key] = (months[key] || 0) + total;
  }));

  const sortedMonths = Object.keys(months).sort();
  const last = months[sortedMonths.at(-1)] || 0;
  const prev = months[sortedMonths.at(-2)] || 0;
  const diff = prev ? (((last - prev) / prev) * 100).toFixed(1) : 0;

  renderShell(u, `
    <div class="bento-grid">

      <div class="card col-6">
        <button class="btn-main" onclick="exportAllPDF()">
  ‚¨á Export PDF
</button>

        <div class="stat-badge">${t('totalRevenue')}</div>
        <div class="stat-val">‚Çπ${rev.toLocaleString()}</div>
      </div>

      <div class="card col-6">
        <div class="stat-badge">${t('farmers')}</div>
        <div class="stat-val">${users.length}</div>
      </div>

      <div class="card col-3"><div class="stat-val">${sold.t2}</div><div class="stat-label">2L ${t('packets')}</div></div>
      <div class="card col-3"><div class="stat-val">${sold.t1}</div><div class="stat-label">1L ${t('packets')}</div></div>
      <div class="card col-3"><div class="stat-val">${sold.t34}</div><div class="stat-label">3/4L ${t('packets')}</div></div>
      <div class="card col-3"><div class="stat-val">${sold.t12}</div><div class="stat-label">1/2L ${t('packets')}</div></div>

      <div class="card col-6">
        <div class="stat-badge">Income Comparison</div>
        <div class="stat-val">‚Çπ${last}</div>
        <div class="stat-label">
          ${diff >= 0 ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è'} ${Math.abs(diff)}% vs last month
        </div>
      </div>

    </div>
  `, 'summary');
}

function getFarmerStatus(sales = []) {
  if (!sales.length) {
    return { label: 'Inactive', color: '#9ca3af', icon: '‚ö™' };
  }

  const lastDate = sales[sales.length - 1].date;
  const [d, m, y] = lastDate.split('/');
  const last = new Date(y, m - 1, d);
  const diff = (Date.now() - last.getTime()) / (1000 * 60 * 60 * 24);

  if (diff <= 2) return { label: 'Active', color: '#16a34a', icon: 'üü¢' };
  if (diff <= 7) return { label: 'Idle', color: '#f59e0b', icon: 'üü°' };

  return { label: 'Inactive', color: '#dc2626', icon: 'üî¥' };
}
function getUserLiveStatus(lastActive) {
  if (!lastActive) {
    return { label: 'Offline', color: '#dc2626', icon: 'üî¥' };
  }

  const diff = Date.now() - lastActive;

  if (diff < 5 * 60 * 1000) {
    return { label: 'Active', color: '#16a34a', icon: 'üü¢' };
  }

  if (diff < 30 * 60 * 1000) {
    return { label: 'Idle', color: '#f59e0b', icon: 'üü°' };
  }

  return { label: 'Offline', color: '#dc2626', icon: 'üî¥' };
}
async function adminUsers() {
  saveLastTab('users');
showLogoLoader();

  const u = JSON.parse(localStorage.getItem('user'));
  const res = await fetch('/users');
  const users = await res.json();
updateLastSync();
  renderShell(u, `
    <div class="search-wrap">
  <span>üîç</span>
  <input
    class="search-input"
    placeholder="Search farmer name or date‚Ä¶"
    oninput="filterFarmers(this.value)"
  />
</div>


    <div class="bento-grid">
      ${users.map(usr => {
  const status = getUserLiveStatus(usr.lastActive);

  return `
    <div class="card col-4 farmer-card"
         onclick="editUser('${usr.username}')">

      <div style="font-size:38px">üë®‚Äçüåæ</div>

      <h3 style="margin:6px 0">${usr.username}</h3>

      <span style="
        display:inline-flex;
        align-items:center;
        gap:6px;
        padding:4px 12px;
        border-radius:20px;
        font-size:11px;
        font-weight:800;
        background:${status.color}20;
        color:${status.color};
      ">
        ${status.icon} ${status.label}
      </span>

      <p style="font-size:12px;color:var(--text-sub);margin-top:8px">
        Tap to manage
      </p>
    </div>
  `;
}).join('')
}
    </div>
  `, 'users');
  startAdminUserRefresh();

}

function filterFarmers(query) {
  query = query.toLowerCase();
  document.querySelectorAll('.farmer-card').forEach(card => {
    card.style.display =
      card.innerText.toLowerCase().includes(query) ? 'block' : 'none';
  });
}


function startVoiceOrder() {
  const Speech =
    window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!Speech) {
    alert("Voice input not supported");
    return;
  }

  const rec = new Speech();
  rec.lang = currentLang === 'te' ? 'te-IN' : 'en-IN';
  rec.start();

  showToast(
    currentLang === 'te'
      ? "üéôÔ∏è ‡∞µ‡∞ø‡∞®‡∞ø‡∞™‡∞ø‡∞∏‡±ç‡∞§‡±ã‡∞Ç‡∞¶‡∞ø..."
      : "üéôÔ∏è Listening..."
  );

  rec.onresult = e => {
    const text = e.results[0][0].transcript.toLowerCase();
    showToast("üéôÔ∏è " + text);

    if (text.includes('2') || text.includes('‡∞∞‡±Ü‡∞Ç‡∞°‡±Å')) {
      document.getElementById('oq').value = 2;
    } else if (text.includes('1') || text.includes('‡∞í‡∞ï')) {
      document.getElementById('oq').value = 1;
    } else if (
      text.includes('half') ||
      text.includes('‡∞∏‡∞ó‡∞Ç')
    ) {
      document.getElementById('oq').value = 0.5;
    }
  };
}
function startAdminUserRefresh() {
  if (adminUsersInterval) return;

  adminUsersInterval = setInterval(() => {
    const u = JSON.parse(localStorage.getItem('user'));

    // ‚úÖ ONLY refresh IF admin is CURRENTLY on users page
    if (
      u?.role === 'admin' &&
      getLastTab() === 'users' &&
      !isEditingUser
    ) {
      adminUsers();
    }
  }, 60000);
}



async function editUser(name) {
  isEditingUser = true;

  const u = JSON.parse(localStorage.getItem('user')); const res = await fetch('/users'); const users = await res.json();
  const target = users.find(x => x.username === name);
  const st = calculateStats(target.sales);
  
  renderShell(u, `
<button class="btn-sec"
  onclick="isEditingUser=false; adminUsers()"
  style="margin-bottom:20px">
  ‚¨Ö Back
</button>
    <div class="bento-grid">
      <div class="card col-6">
        <h3>Add Entry: ${name}</h3>
        <input type="date" id="d" style="background:var(--surface); border:1px solid var(--surface-border); padding:14px; border-radius:14px; width:100%; margin-bottom:16px">
        <div class="milk-grid">
  <div class="milk-btn" onclick="tog(this,'twoL')">ü•õ 2 Litre</div>
  <div class="milk-btn" onclick="tog(this,'oneL')">ü•õ 1 Litre</div>
  <div class="milk-btn" onclick="tog(this,'threeQuarterL')">ü•õ 0.75 L</div>
  <div class="milk-btn" onclick="tog(this,'halfL')">ü•õ 0.5 L</div>
</div>

        <button class="btn-main"
  onclick="safeAction(() => save('${name}'))">${t('save')}</button>
      </div>
      <div class="card col-6">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px">
           <span>Total: <b>‚Çπ${st.total}</b></span><span>Entries: <b>${st.days}</b></span>
        </div>
        <div class="table-wrapper" style="max-height:400px; overflow-y:auto">
           <table>
             ${target.sales.slice().reverse().map(s => `<tr><td>${s.date}</td><td>‚Çπ${(s.twoL*140)+(s.oneL*70)+(s.threeQuarterL*55)+(s.halfL*35)}</td><td style="color:red; cursor:pointer" onclick="safeAction(() => del('${name}','${s.date}'))">‚úï</td></tr>`).join('')}
           </table>
        </div>
      </div>
    </div>
    <div class="card col-6">
  <h3>Order History</h3>
  <div class="table-wrapper" style="max-height:300px;overflow-y:auto">
    <table>
      <tr>
        <th>Date</th>
        <th>Qty</th>
        <th>Status</th>
      </tr>
      ${target.orders?.length
        ? target.orders.slice().reverse().map(o => `
            <tr>
              <td>${new Date(o.timestamp).toLocaleDateString()}</td>
              <td>${o.quantity}L</td>
              <td>${o.status}</td>
            </tr>
          `).join('')
        : `<tr><td colspan="3">No orders</td></tr>`
      }
    </table>
  </div>
</div>

  `, 'users');
  document.querySelectorAll('.milk-btn').forEach(btn => {
  makeAccessible(btn, () => btn.click(), 'Select milk quantity');
});

}

async function userOrders() {
  saveLastTab('orders');
  const u = JSON.parse(localStorage.getItem('user')); const res = await fetch(`/orders/${u.username}`); const orders = await res.json();
  renderShell(u, `
    <div class="bento-grid">
      <div class="card col-5">
        <button class="btn-sec" onclick="startVoiceOrder()">üéôÔ∏è Voice Order</button>

        <h3>${t('requestMilk')}</h3>
        <select id="oq" style="width:100%; padding:16px; border-radius:16px; border:2px solid var(--surface-border); margin:16px 0; font-size:15px; font-weight:600">
           <option value="1">1 Litre</option><option value="2">2 Litres</option><option value="0.5">0.5 Litre</option>
        </select>
       <button class="btn-main"
  onclick="safeAction(() => placeOrder('${u.username}'))">${t('submit')}</button>
      </div>
      <div class="card col-7">
        <button class="btn-sec" onclick="startVoiceOrder()">üéôÔ∏è Voice Order</button>

        <h3>History</h3>
        <div class="table-wrapper" style="max-height:300px; overflow-y:auto">
           <table>
${orders.length === 0 
  ? emptyState({
      icon: 'üõí',
      title: 'No orders yet',
      message: 'You have not placed any milk orders.',
      actionText: 'Order Milk',
      action: 'userOrders()'
    })
  : orders.map(o => `
      <tr>
        <td>${new Date(o.timestamp).toLocaleDateString()}</td>
        <td>${o.quantity}L</td>
        <td>${o.status}</td>
      </tr>
    `).join('')
}
           </table>
        </div>
      </div>
    </div>
  `, 'orders');
}
function updateUserActivity() {
  const user = JSON.parse(localStorage.getItem('user'));
  if (!user) return;

  const now = Date.now();
  localStorage.setItem('lastActive', now);

  fetch('/update-activity', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      username: user.username,
      lastActive: now
    })
  }).catch(()=>{});
}

let activityTimeout = null;

function throttledActivity() {
  if (activityTimeout) return;
  activityTimeout = setTimeout(() => {
    updateUserActivity();
    activityTimeout = null;
  }, 60000); // once per minute
}

['click','keydown','touchstart'].forEach(evt => {
  window.addEventListener(evt, throttledActivity, { passive:true });
});



async function adminOrders() {
  saveLastTab('orders');
  const u = JSON.parse(localStorage.getItem('user')); const res = await fetch('/orders'); const orders = await res.json();
  const pending = orders.filter(o => o.status === 'Pending');
  renderShell(u, `
    <div class="bento-grid">
       ${pending.map(o => `
         <div class="card col-4">
           <h3>${o.username}</h3>
           <div class="stat-val" style="font-size:1.5rem">${o.quantity}L</div>
           <p>${new Date(o.timestamp).toLocaleString()}</p>
           <button class="btn-main"
  onclick="safeAction(() => acceptOrder('${o.id}'))">Approve ‚úÖ</button>
         </div>
       `).join('')}
${pending.length === 0 
  ? emptyState({
      icon: 'üéâ',
      title: 'All caught up!',
      message: 'There are no pending orders right now.'
    })
  : ''
}
    </div>
  `, 'orders');
}
function getCustomerSince(sales = []) {
  if (!sales.length) return "‚Äî";

  const sorted = sortSalesByDate([...sales]);
  const [d, m, y] = sorted[0].date.split('/');
  return `${getMonthName(m)} ${y}`;
}
async function downloadMonthPDF(username, month, year) {
  // 1. Correct way to access jsPDF v2+
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // 2. Fetch fresh data to ensure we have it correctly
  const res = await fetch(`/user/${username}`);
  const data = await res.json();
  
  // 3. Filter for specific month/year
  const monthSales = data.sales.filter(s => {
    const [, m, y] = s.date.split('/');
    return Number(m) === Number(month) && Number(y) === Number(year);
  });

  if (monthSales.length === 0) {
    showToast("No data to download");
    return;
  }

  // 4. PDF Styling
  doc.setFontSize(20);
  doc.setTextColor(16, 185, 129); // Brand Green
  doc.text("‡∞∞‡±à‡∞§‡±Å ‡∞™‡∞æ‡∞≤‡±Å", 105, 20, { align: "center" });
  
  doc.setFontSize(12);
  doc.setTextColor(100);
  doc.text(`Milk Report: ${getMonthName(month)} ${year}`, 105, 30, { align: "center" });
  doc.text(`Farmer: ${username}`, 14, 45);

  const tableRows = [];
  let grandTotal = 0;

  monthSales.forEach(s => {
    const cost = (s.twoL*140) + (s.oneL*70) + (s.threeQuarterL*55) + (s.halfL*35);
    grandTotal += cost;
    const qty = `${s.twoL?s.twoL+'x2L ':''}${s.oneL?s.oneL+'x1L ':''}${s.threeQuarterL?s.threeQuarterL+'x3/4L ':''}${s.halfL?s.halfL+'x1/2L':''}`;
    tableRows.push([s.date, qty, `‚Çπ${cost}`]);
  });

  // 5. Generate Table
  doc.autoTable({
    startY: 50,
    head: [['Date', 'Quantity', 'Amount']],
    body: tableRows,
    headStyles: { fillColor: [16, 185, 129] },
    foot: [['', 'Grand Total', `‚Çπ${grandTotal}`]],
    footStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0], fontStyle: 'bold' }
  });

  doc.save(`${username}_${getMonthName(month)}_${year}.pdf`);
  fireConfetti();
}

function getUserActivityStatus(sales = []) {
  if (!sales.length) return { label: 'New Member', color: '#6b7280', icon: '‚ú®' };
  
  const sorted = sortSalesByDate([...sales]);
  const lastDate = sorted[sorted.length - 1].date;
  const [d, m, y] = lastDate.split('/');
  const last = new Date(y, m - 1, d);
  const diffDays = (new Date() - last) / (1000 * 60 * 60 * 24);

  if (diffDays <= 3) return { label: 'Regular', color: '#10b981', icon: 'üü¢' };
  if (diffDays <= 10) return { label: 'Occasional', color: '#f59e0b', icon: 'üü°' };
  return { label: 'Inactive', color: '#ef4444', icon: 'üî¥' };
}
async function userProfile() {
  saveLastTab('profile');
showLogoLoader();

  const u = JSON.parse(localStorage.getItem('user'));
  const res = await fetch(`/user/${u.username}`);
  const data = await res.json();
const since = getCustomerSince(data.sales);
const status = getUserActivityStatus(data.sales);

  const stats = calculateStats(data.sales);

  renderShell(u, `
    <div style="max-width:900px; margin:0 auto">

      <div class="card" style="
        display:flex;
        gap:24px;
        align-items:center;
        margin-bottom:24px
      ">
        <div style="
          width:120px;
          height:120px;
          border-radius:50%;
          background:var(--gradient-soft);
          display:flex;
          align-items:center;
          justify-content:center;
          font-size:48px
        ">
          üë§
        </div>

        <div>
          <h2 style="margin-bottom:6px">${u.username}</h2>
          <p style="color:var(--text-sub)">
            Milk Consumer ‚Ä¢ Raithu Palu
          </p>

          <div style="margin-top:10px;display:flex;gap:14px;flex-wrap:wrap">

  <span style="
    padding:4px 10px;
    border-radius:20px;
    font-size:12px;
    font-weight:700;
    background:${status.color}20;
    color:${status.color};
  ">
    ${status.icon} ${status.label}
  </span>

  <span style="
    font-size:12px;
    color:var(--text-sub);
  ">
    üìÖ Customer since ${since}
  </span>

</div>

        </div>
      </div>

      <div class="bento-grid">
        <div class="card col-3">
          <div class="stat-val">${stats.days}</div>
          <div class="stat-label">Active Days</div>
        </div>

        <div class="card col-3">
          <div class="stat-val">${stats.t1 + stats.t2 + stats.t34 + stats.t12}</div>
          <div class="stat-label">Total Milk Packs</div>
        </div>

        <div class="card col-3">
          <div class="stat-val">‚Çπ${stats.total}</div>
          <div class="stat-label">Total Spend</div>
        </div>

        <div class="card col-3">
          <div class="stat-val">
            ${stats.t1 >= stats.t2 ? '1L' : '2L'}
          </div>
          <div class="stat-label">Preferred Size</div>
        </div>
      </div>

      <div class="card" style="margin-top:32px">
        <h3 style="margin-bottom:10px">Security</h3>
        <p style="color:var(--text-sub); margin-bottom:16px">
          Change your account password securely.
        </p>

        <button class="btn-sec"
          onclick="document.getElementById('passBox').style.display='block'">
          üîê Change Password
        </button>

        <div id="passBox" style="display:none; margin-top:20px">
          <input id="oldP" type="password" placeholder="Current Password" style="width:100%; padding:14px; border-radius:14px; border:2px solid var(--surface-border); margin-bottom:12px">
          <input id="newP" type="password" placeholder="New Password" style="width:100%; padding:14px; border-radius:14px; border:2px solid var(--surface-border); margin-bottom:12px">

          <button class="btn-main"
            onclick="safeAction(() => changePass('${u.username}'))">
            Update Password
          </button>
        </div>
      </div>

    </div>
  `, 'profile');
}

let isOffline = !navigator.onLine;
window.addEventListener('offline', () => {
  isOffline = true;
  showNetStatus('offline', 'üì¥ Offline mode');
  disableActions(true);
});

function calculateBill(entry) {
  return (entry.twoL || 0) * PRICES.twoL +
         (entry.oneL || 0) * PRICES.oneL +
         (entry.threeQuarterL || 0) * PRICES.threeQuarterL +
         (entry.halfL || 0) * PRICES.halfL;
}

// Then update your loops like this:
// const cost = calculateBill(s);
window.addEventListener('online', () => {
  isOffline = false;
  showNetStatus('online', '‚úÖ Back online');
  disableActions(false);
});
function disableActions(disable) {
  document.querySelectorAll('.btn-main').forEach(btn => {
    btn.disabled = disable;
    btn.style.opacity = disable ? '0.6' : '1';
    btn.style.pointerEvents = disable ? 'none' : 'auto';
  });
}
function exportAllPDF() {
  fetch('/users')
    .then(r => r.json())
    .then(users => {
      const { jsPDF } = window.jspdf;
      if (!jsPDF) {
        alert("PDF library not loaded");
        return;
      }

      const doc = new jsPDF();

      /* ---------- WATERMARK ---------- */
      doc.addImage(APP_LOGO_URL, "PNG", 30, 90, 150, 150, undefined, "FAST");
      doc.setGState(new doc.GState({ opacity: 0.08 }));

      doc.setGState(new doc.GState({ opacity: 1 }));
      doc.setFontSize(16);
      doc.text("‡∞∞‡±à‡∞§‡±Å ‡∞™‡∞æ‡∞≤‡±Å ‚Äì Farmers Report", 105, 20, { align: "center" });

      let y = 30;

      users.forEach(user => {
        doc.setFontSize(12);
        doc.text(`Farmer: ${user.username}`, 14, y);
        y += 6;

        if (!user.sales.length) {
          doc.text("No entries", 18, y);
          y += 6;
        }

        user.sales.forEach(s => {
          const total =
            (s.twoL*140)+(s.oneL*70)+(s.threeQuarterL*55)+(s.halfL*35);
          doc.text(`${s.date} ‚Üí ‚Çπ ${total}`, 18, y);
          y += 6;

          if (y > 270) {
            doc.addPage();
            y = 20;
          }
        });

        y += 10;
      });

      doc.save("raithu-palu-farmers-report.pdf");
    })
    .catch(() => alert("Failed to export PDF"));
}

function tog(btn, type) {
  btn.classList.toggle('active');
  selectedMilk[type] = selectedMilk[type] ? 0 : 1;
}
async function save(username) {
  const dateInput = document.getElementById('d').value;
  if (!dateInput) {
    showToast("Select date");
    return;
  }

  const [y, m, d] = dateInput.split('-');
  const date = `${d}/${m}/${y}`;

  const res = await fetch('/user/' + username);
  const data = await res.json();

  const existing = data.sales.find(s => s.date === date);

  const finalSale = {
    date,
    twoL: (existing?.twoL || 0) + (selectedMilk.twoL || 0),
    oneL: (existing?.oneL || 0) + (selectedMilk.oneL || 0),
    threeQuarterL: (existing?.threeQuarterL || 0) + (selectedMilk.threeQuarterL || 0),
    halfL: (existing?.halfL || 0) + (selectedMilk.halfL || 0),
  };

  await fetch('/add-sale', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      username,
      sale: finalSale
    })
  });

  selectedMilk = { twoL:0, oneL:0, threeQuarterL:0, halfL:0 };
  logAudit("ADD_MILK_ENTRY", {
  user: username,
  date: date,
  milk: { ...selectedMilk }
  
});
  if (Object.values(selectedMilk).every(v => v === 0)) {
    showToast("Please select at least one milk type!");
    return;
}
  fireConfetti();
  showToast("Milk entry updated ü•õ");
  editUser(username);
}
async function del(n, d) {
  if (!confirm("Delete this entry?")) return;

  await fetch('/delete-sale', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ username:n, date:d })
  });

  logAudit("DELETE_MILK_ENTRY", {
    user: n,
    date: d
  });

  showToast("Deleted");
  editUser(n);
}
async function changePass(u){const o=document.getElementById('oldP').value,n=document.getElementById('newP').value;const r=await fetch('/change-password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,oldPassword:o,newPassword:n})});const d=await r.json();d.success?(fireConfetti(),showToast('Success'),userProfile()):alert(d.error);if(n.length < 6) {
    showToast("New password must be at least 6 characters");
    return;
}}
async function placeOrder(u){const q=document.getElementById('oq').value;await fetch('/place-order',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,quantity:q})});fireConfetti();showToast('Order Sent üöÄ');userOrders();addNotification("üõí Order placed successfully");}
async function acceptOrder(id) {
  // 1. Get order
  const res = await fetch('/orders');
  const orders = await res.json();
  const order = orders.find(o => o.id === id);
  if (!order) return;

  const username = order.username;
  const qty = order.quantity; // 1, 2, 0.5
  const today = new Date();
  const date = `${String(today.getDate()).padStart(2,'0')}/${String(today.getMonth()+1).padStart(2,'0')}/${today.getFullYear()}`;

  // 2. Fetch user data
  const uRes = await fetch(`/user/${username}`);
  const uData = await uRes.json();

  const existing = uData.sales.find(s => s.date === date);

  // 3. Map quantity to milk type
  const add = { twoL:0, oneL:0, threeQuarterL:0, halfL:0 };
  if (qty == 2) add.twoL = 1;
  if (qty == 1) add.oneL = 1;
  if (qty == 0.75) add.threeQuarterL = 1;
  if (qty == 0.5) add.halfL = 1;

  const finalSale = {
    date,
    twoL: (existing?.twoL || 0) + add.twoL,
    oneL: (existing?.oneL || 0) + add.oneL,
    threeQuarterL: (existing?.threeQuarterL || 0) + add.threeQuarterL,
    halfL: (existing?.halfL || 0) + add.halfL,
  };

  // 4. Save sale
  await fetch('/add-sale', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ username, sale: finalSale })
  });

  // 5. Approve order
  await fetch('/update-order', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ id, status:'Success' })
  });

  fireConfetti();
  showToast("Order approved & added to milk entry ü•õ");
  logAudit("ORDER_APPROVED", {
  orderId: id,
  username: username,
  quantity: qty
});

  adminOrders();
}
function downloadPDF(title){const {jsPDF}=window.jspdf;const doc=new jsPDF();doc.text(title,14,20);doc.autoTable({html:'#pdfTable',startY:30});doc.save(title+'.pdf');}
async function login() {
  const u = document.getElementById('u').value;
  const p = document.getElementById('p').value;

  const r = await fetch('/login', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ username:u, password:p })
  });

  const d = await r.json();
  if (!d) return alert('Invalid');

  localStorage.setItem('user', JSON.stringify({
    username: u,
    role: d.role
  }));

  localStorage.removeItem('lastTab'); // üî• VERY IMPORTANT

  d.role === 'admin' ? adminSummary() : userHome();
}

async function register(){const u=document.getElementById('ru').value,p=document.getElementById('rp').value;await fetch('/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});alert('Registered');location.reload();}
function logout(){
  localStorage.removeItem('user');
  localStorage.removeItem('lastTab');
  isEditingUser = false;

  if (adminUsersInterval) {
    clearInterval(adminUsersInterval);
    adminUsersInterval = null;
  }

  renderAuth();
}
function toggleAuth(v){document.getElementById('loginForm').style.display=v==='login'?'block':'none';document.getElementById('regForm').style.display=v==='reg'?'block':'none';}
function togglePass(id){const x=document.getElementById(id);x.type=x.type==='password'?'text':'password';}

function safeAction(action, options = {}) {
  const {
    offlineMsg = 'üì¥ No internet connection',
    before = null,
    after = null
  } = options;

  if (!navigator.onLine) {
    showNetStatus('offline', offlineMsg);
    return;
  }

  if (before) before();

  const result = action();

  if (result instanceof Promise && after) {
    result.then(after);
  }
}

function renderAuth() {
  app.innerHTML = `
    <div class="auth-wrap">
      <div class="auth-glass">
          <img
    class="logo-glow"
    src="${APP_LOGO_URL}"
    alt="‡∞∞‡±à‡∞§‡±Å ‡∞™‡∞æ‡∞≤‡±Å Logo"
    style="
      width:120px;
      height:120px;
      border-radius:50%;
      margin-bottom:16px;
      box-shadow:0 12px 30px rgba(0,0,0,0.15);
      object-fit:cover;
    "
  />
        <div class="auth-logo">üåæ</div>
        <div class="auth-title">welcome to ‡∞∞‡±à‡∞§‡±Å ‡∞™‡∞æ‡∞≤‡±Å</div>
        <div class="auth-sub">Premium Farm Management</div>

        <div id="loginForm">
          <input id="u" class="auth-input" placeholder="Username">

          <div class="auth-pass">
            <input id="p" type="password" class="auth-input" placeholder="Password">
            <span onclick="togglePass('p')">üëÅÔ∏è</span>
          </div>

          <button class="auth-btn" onclick="login()">Login</button>

          <div class="auth-link" onclick="toggleAuth('reg')">
            Create Account
          </div>
        </div>

        <div id="regForm" style="display:none">
          <input id="ru" class="auth-input" placeholder="Username">

          <div class="auth-pass">
            <input id="rp" type="password" class="auth-input" placeholder="Password">
            <span onclick="togglePass('rp')">üëÅÔ∏è</span>
          </div>

          <button class="auth-btn" onclick="register()">Create Account</button>

          <div class="auth-link" onclick="toggleAuth('login')">
            Back to Login
          </div>
        </div>

      </div>
    </div>
  `;
}


async function initApp() {
  showLogoLoader();
  
  const savedUser = JSON.parse(localStorage.getItem('user'));
  
  if (!savedUser) {
    renderAuth();
    return;
  }

  try {
    // Set a timeout for the fetch
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), 10000); // 10 seconds

    if (savedUser.role === 'admin') {
      await adminSummary();
    } else {
      await userHome();
    }
    clearTimeout(id);
  } catch (err) {
    console.error("Init error:", err);
    // If server is down/slow, try to render with cached data or show login
    showToast("Server is waking up... Please wait");
    setTimeout(initApp, 3000); // Retry after 3 seconds
  }
}

// Start the app
initApp();
</script>
<div id="netStatus" style="
  position: fixed;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  padding: 12px 24px;
  border-radius: 0 0 20px 20px;
  font-weight: 700;
  font-size: 14px;
  color: white;
  z-index: 99999;
  display: none;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  backdrop-filter: blur(10px);
"></div>

</body>
</html>